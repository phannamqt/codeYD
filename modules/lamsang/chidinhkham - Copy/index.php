<!--author: Phan Nam-->
<!--
04/02/15 :Nếu lỗi lưu % BHYT sai thì do trong bảng khám phantram để kiểu tinyint nên phải làm tròn số phần trăm

-->

<style type="text/css">
.bongmo{
	background: #aaaaaa;
	opacity: .3;	
}
#n_dangluu{
	position:relative;
	top: -48%;
	left: 45%;
	width: auto;
	z-index:999;
	padding: 3px;
	margin: 5px;
	height:22px;
	width:100px;
	text-align: center;
	font-weight: bold;
	display: block;
	border:solid 2px #DFD9C3;
	font-size:13px;
	background:#FBFAF5;
	color:#55A616;
	box-shadow: 2px #919191;
}
.tooltips{
	left:950px !important;
}
.nam-hover:hover{
	color:#000;
	background:#008DDF!important;
}
.frame_u78787878975f{
	width:300px!important;
	text-align:center!important;
	height:auto;
	}
.frame_u78787878975f2{
	width:300px!important;
	text-align:center!important;
	height:auto;
	}
th.ui-th-column div{
	word-wrap: break-word; /* IE 5.5+ and CSS3 */
	white-space: pre-wrap; /* CSS3 */
	white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
	white-space: -pre-wrap; /* Opera 4-6 */
	white-space: -o-pre-wrap; /* Opera 7 */
	overflow: hidden;
	height: auto !important;
	vertical-align: middle;
}
#rowed3 td,#rowed4 td,#rowed5 td{

	font-size:11px!important;	   
}

.ui-menu { 
	width: 150px;
	display:none;
	position:absolute;  	 
	box-shadow:0px 0px 3px #333;
	z-index:100000;  
}
.grid1
{
	width:180px;
	display:inline-block;
}
#menu_toggle{
	font-size:12px;
	padding:5px 0px;
	background:url("js/grid/themes/south-street/images/ui-bg_highlight-hard_15_459e00_1x100.png") repeat-x scroll   #b3ffb3;
	border:#CCC 1px dashed;	
}
#gbox_rowed3, #gbox_rowed4, #gbox_rowed5, #gbox_rowed6, #gbox_rowed7{
	margin-left:4px;
	margin-top:0px;
	box-shadow:0px 0px 10px #a0a0a0;
	border:1px solid #919191; 
}#n_menu{
	border-radius: 6px 6px 6px 6px;
	border: 1px solid #d4ccb0;
	height:40px;
	margin: 5px;
}#n_bt{
	border-radius: 6px 6px 6px 6px;
	border: 1px solid #d4ccb0;
	height:30px;
	margin: 3px;
	display:none;			
	}
#n_menu_left{
	margin:10px;
	}
#chongoikham{
	margin-top: -28px;
	vertical-align: top;
	width: 119px;
	height: 15px;
	float: right;
	margin-right: 5px;	
}#botton{
	position:absolute;  
  	botton:0px;  
	width:98%;  
	height:20px;   /* Height of the footer */  	
	border-radius: 6px 6px 6px 6px;
	border: 1px solid #d4ccb0;
	padding: 10px;
	margin-left:2px;
	margin-top:5px;
	background:#FBFBF5;
}#hentrakq{
	float: left;
	margin-top: -2px;
	
}#bt_left{
	float: left;
	min-width: 450px;
	margin-top: 6px;	
}#bt_right{
	float: left;
	margin-top: -2px;
	width: 800px;	
	
}
#patient_info{

	}
#n_top{
	border-radius: 6px 6px 6px 6px;
	border: 1px solid #d4ccb0;
	height:65px;
	margin: 5px 0px -5px 0px;
	background:#FBFBF5;
}
#n_top_right{
	float: right;
	margin-top: -30px;
	margin-right: 10px;
	}
input.custom_button_n[type="button"] {
    background: none repeat scroll 0 0 rgba(0, 0, 0, 0);
    border: medium none;
    font-size: 11px;
    height: 17px !important;
    outline: medium none;
    text-decoration: underline;
    text-shadow: 0 1px 0 rgba(255, 255, 255, 0.6);
    width: 50px !important;
	color:#00F;
	margin-left:-7px!important;
	width: 35px !important
}input.custom_button_n[type="button"]:hover{
	color:red;
}
select.editable{
	width:70px!important;
	height: 20px!important;
	 padding:0px!important; 
}.colNhomThucHien select.editable{
	width:105px!important;
	height: 20px!important;
	 padding:0px!important; 
}
#tongtien{
	margin-left:276px;
	margin-top:4px;
}#n_top_right{
	display:none;
	}#btn_cddatra,#btn_cdmoi{
		width: 2%;
}#thanhtienvienphi,#thanhtienbhyt,#phithuchien{
	box-shadow:none!important;	
	padding: 0px!important;
	}
.no-close .ui-dialog-titlebar-close {
    display: none;
}.ui-state-hover{
	border:#F00;
}.profile_inner_rate{
	width: 110px!important; 
}.profile_inner_temp{
	width: 99px!important;
}.ui-button-text{
	padding:0em  !important;
}.ui-dialog .ui-dialog-buttonpane button {
	width:40px;
	height:30px;
}.data_chongoikham{
	width:1306px!important;
	height:346px !important;
}
.ui-dialog-buttonset button.ui-button{
 width: 60px!important;
}
#dieutriphoihop{
    height: 15px;
	float:right;
	margin-right: 140px;
	width:120px;
    margin-top: -28px;
    vertical-align: top;	
}
.xanh{
	display:none !important;
}
.ui-jqgrid-bdiv input[type="text"] {
    height: 12px !important;
}
#gbox_rowed5 .ui-button-icon-only {
    width: 1.5em  !important;
	background:url(./images/icon-cb.png) !important;
	box-shadow:none !important;
	border-bottom: 1px solid #327e04 !important;
    border-right: 1px solid #327e04 !important;
    border-top: 1px solid #327e04 !important;
	border-left:none !important;
}
#gbox_rowed5 .ui-button-icon-only .ui-icon {
	background-image:none;
}
#gbox_rowed5 .ui-button-icon-only:hover {
	background:url(./images/icon-cb-hover.png) !important;
	border-bottom: 1px solid #327e04 !important;
    border-right: 1px solid #327e04 !important;
    border-top: 1px solid #327e04 !important;
	border-left:none !important;
}
#gbox_rowed5 .ui-button-icon-only:hover .ui-icon {
	background:none;
}
.nguoichidinh2 input{
	width:50px !important;
}

</style>
<body> 
<input type="hidden" id="mabenhnhan" value="" />
<input type="hidden" id="soluotchon" value="0" />
<input type="hidden" value="0" id="dachidinh" name="dachidinh"> 
<div id="dialog" title="Lý do hủy bỏ"  style="display:none">
  <textarea id="lydohuybo" style="width:375px; height:100px;" ></textarea>
  <input type="hidden" id="idk" value="" />
</div>
<div id="comfrim" title="Lý do hủy bỏ"  style="display:none">

</div>
<div id="dialog_bschinh" title="Thông báo"  style="display:none">
	Loại khám này là khám LS chính nên không thể hủy bỏ, nếu muốn về 0 đồng thì chọn khám LS 0 đồng hoặc miễn giảm.
</div>
<div id="dialog_loi" title="Thông báo"  style="display:none">
Vui lòng chọn một lượt khám để thực hiện chức năng này!!!
</div>
<div id="dialog_loi2" title="Thông báo"  style="display:none">
Vui lòng cấu hình tầng trước khi thực hiện chức năng này!!!
</div>
 <div  class="data_chongoikham" title="<?php lang('chongkc')?>"  style="display:none">
    <table id="data_goikham">
    </table>   
    <br />
	<table id="data_loaikham">
    </table>   
  </div>
 
	<div id='n_top' >
        <div class="patient_info"> </div>
        <div id='n_top_right' >
            <a  id="ghichu" style="margin-left: 5px;" href="#" > <?php lang('ghichu')?></a>
            <a  id="thongtinbn" style="margin-left: 5px;"  href="#" > Thông tin bệnh nhân </a>
        </div>
        </div>
    <div id="panel_main" style="margin-top:10px;" >  
  <!-- <input type="hidden" id="idluotkham" value="257659" /> --> 

     
	<div class="ui-layout-west ui-widget-content left_col">   <table id="rowed3" ></table></div>
        <div class="center_col ui-widget-content ui-layout-center">  <table id="rowed4" ></table> </div>
        <div class="ui-layout-east ui-widget-content right_col">
            
        <div id='n_menu'>
            <div id='n_menu_left'> 
                <a  id="chitietquota" style="margin-left: 5px; display:none" href="#"  > Chi tiết quota</a>
                <a  id="miengiam" style="margin-left: 5px; display:none"  href="#" > <?php lang('miengiam')?> </a>

               
                <!--<button id="dieutriphoihop" class=" ui-state-default ui-corner-all"> Điều trị phối hợp</button>-->
                <span id="thongbao" style="margin-left: 10px; font-weight:bold; color:#F00"> </span>
            </div>
            <button id="btn_sapxep_hangmuc"  class="fm-button ui-state-default ui-corner-all"  style="visibility: visible; top: -28px; float: right; display:none">Sắp xếp STT</button>
          <a  id="dieutriphoihop" class="fm-button ui-state-default ui-corner-all" style="display:none;"> <?php lang('dieutriph')?></a>
       	 <a  id="chongoikham" style="display:none" class="fm-button ui-state-default ui-corner-all"> <?php lang('chongk')?></a>

   		</div>
        <table id="rowed5" ></table> 
       
		<div id='n_bt'> </div>
        <div id="n_dangluu" style="display:none">
           	 Đang lưu...
        </div>
		</div>
		
    </div>
    <div id='botton' >
    	<div id="bt_left" style=" min-width: 450px; ">
			<div id='dukiencokq'  style=" float: left; margin-left: 1%; display:none;">
				<?php lang('giodkkq')?><span id="hienthidukiencokq"> </span>
			  </div>
			 <div id='hentrakqmoi' style=" float: left; margin-left: 7%; display:none; ">
				<?php lang('gdkkqm')?><span id="hienthihentrakqmoi"> </span>
			  </div>
           </div>
           <div id="bt_right">
				<a  id="hentrakq" class="fm-button ui-state-default ui-corner-all "  > <span class="ui-button-text"><?php lang('hentrakq')?></span></a>
                <input type="checkbox" id="btn_cddatra" style=" margin-left: 1%; " checked /><?php lang('hiencdhb')?>
                <input type="checkbox" id="btn_cdmoi" style=" margin-left: 1%; " /><?php lang('incdmoi')?>
                
                <a  id="btn_xemin" class="fm-button ui-widget ui-state-default ui-corner-all fm-button-icon-left ui-button-text-only " style=" margin-left: 1%;  margin-top: -3px;"  >
                <span class="ui-button-text"><?php lang('xemincd')?><span class="ui-icon ui-icon-document"></span></span>
                 </a>
                 <a  id="btn_in" class="fm-button ui-widget ui-state-default ui-corner-all fm-button-icon-left ui-button-text-only " style=" margin-left: 1%;  margin-top: -3px;"  >
                <span class="ui-button-text"><?php lang('incd')?><span class="ui-icon ui-icon-print"></span></span>
                 </a>
				<a  id="btn_luu" class="fm-button ui-widget ui-state-default ui-corner-all fm-button-icon-left ui-button-text-only " style=" margin-left: 1%;  margin-top: -3px;"  >
                <span class="ui-button-text"><?php lang('luucc')?> [Ctrl+S]<span class="ui-icon ui-icon-disk"></span></span>
                 </a>
                 
                 <a  id="btn_chidinh" class="fm-button ui-widget ui-state-default ui-corner-all fm-button-icon-left ui-button-text-only " style=" margin-left: 1%;  margin-top: -3px;"  >
                <span class="ui-button-text">Chỉ định [F12]<span class="ui-icon ui-icon-disk"></span></span>
                 </a>

        	</div>
		</div>	
 </body>
</html> 

<script type="text/javascript">
var report_code=["PhieuChiDinh"];
var report_name=["Phiếu chỉ định"];
    jQuery(document).ready(function() {
		window.aduto_tick_bhyt=0;
		jwerty.key('ctrl+s', false);
		openform_shortcutkey();	
		window.n_incd=0;
		window.loadformlandau=0;
		window.phantrammoi=100;
		//$("#dieutriphoihop").button();
		setTimeout(function(){
		//window.ds_tang=$.cookie("dstang");
			window.ds_tang=3;
			$('#dialog_loi2').dialog({
				autoOpen: false,
				width: 350,
				height:150,
				modal: true,
				resizable: false,
				closeOnEscape: true,
					buttons: {
					"Ok": function() {
						$( this ).dialog( "close" );
					}
				}
			 });
			
			 $('#dialog_bschinh').dialog({
				autoOpen: false,
				width: 350,
				height:180,
				modal: true,
				resizable: false,
				closeOnEscape: true,
					buttons: {
					"Ok": function() {
						$( this ).dialog( "close" );
					}
				}
			 });
				
			if(window.ds_tang==""){
				$( "#dialog_loi2" ).dialog('open');
			}else{
				window.new_ds_tang=window.ds_tang;
			}
		},300);
		<?php 
		$data= new SQLServer;
		$params = array($_GET['idluotkham']);
		$store_name="{call Gd2_ThongTinLuotKham_GetAllByID_LuotKham_New(?)}";
		$get=$data->query( $store_name,$params);
		$excute= new SQLServerResult($get);
		$tam= $excute->get_as_array();
		
		echo 'window.idluotkham='.$_GET['idluotkham'].';';
		echo 'window.loaidoituongkham="'.$tam[0]['LoaiDoiTuongKham'].'";';
		echo 'window.idbenhnhan='.$tam[0]['ID_BenhNhan'].';';
		echo 'window.n_idtrangthai="'.$tam[0]['ID_TrangThai'].'";';
		echo 'window.n_dathanhtoanbill="'.$tam[0]['DaThanhToanBill'].'";'; //
		echo 'window.n_id_quoctich="'.$tam[0]['ID_QuocTich'].'";';
		echo 'window.n_hesotheoquoctich="'.$tam[0]['HeSoVienPhi'].'";';
		echo 'window.id_phanloaikham="'.$tam[0]['ID_PhanLoaiKham'].'";';
		echo 'window.n_ngayvaokham="'.$tam[0]['ThoiGianVaoKham']->format($_SESSION["config_system"]["ngaythang"]).'";';
		echo 'window.n_ngayhientai="'.$tam[0]['NgayHienTai']->format($_SESSION["config_system"]["ngaythang"]).'";';
		echo 'window.n_maloaidt="'.$tam[0]['MaLoaiDT'].'";';
		echo 'window.n_songaythe="'.$tam[0]['SoNgayThe'].'";';
		echo 'window.n_trangthaikham="'.$tam[0]['TrangThaiKham'].'";';
		echo 'window.n_quangay="'.$tam[0]['QuaNgay'].'";';
		if($tam[0]['PhanTram']=='.00'){
			echo 'window.phantram="0";';
		}else{
			echo 'window.phantram="'.$tam[0]['PhanTram'].'";';
		}
		?>
		window.colshow=1;
		window.phantram=window.phantram.split('.');
		window.phantram=window.phantram[0];
		//alert(window.phantram);
		if(window.id_phanloaikham==46){
			window.n_khoachidinh=1;	
		}else{
			if(window.id_phanloaikham==24){
				if(window.n_quangay==0 || window.n_quangay==1){
					window.n_khoachidinh=0;
				}else{
					window.n_khoachidinh=1;	
				}
			}else{
				if(window.n_ngayvaokham==window.n_ngayhientai){
					window.n_khoachidinh=0;
				}else{
					window.n_khoachidinh=1;	
				}
			}
		}
		
		if(window.n_id_quoctich==138 || window.n_id_quoctich==142 || window.n_id_quoctich==143){
			window.n_nguoinuocngoai=0;	
		}else{
			window.n_nguoinuocngoai=1;
		}
		window.chophepluu=0;
		
		
		$("#dieutriphoihop").click(function(e) {
            parent.postMessage("dieutriphoihop;"+window.idluotkham+";;"+window.idbenhnhan, "*");
        });
		if(window.id_phanloaikham==46){
			$("#thongbao").html("Thông báo: Lượt khám này là lượt khám nội trú");
			$("#btn_luu").prop("disabled",true);
			$("#btn_chidinh" ).prop("disabled",true);
		}else if(window.n_dathanhtoanbill==1){
			$("#thongbao").html("Thông báo: Lượt khám này đã thanh toán");
			$("#btn_luu").prop("disabled",true);
			$("#btn_chidinh" ).prop("disabled",true);
		}else if(window.n_khoachidinh==1){
			$("#thongbao").html("Thông báo: Lượt khám này đã qua ngày");
			$("#btn_luu").prop("disabled",true);
			$("#btn_chidinh" ).prop("disabled",true);
		}
		temp = jQuery(window).height() - 125;
        $("#panel_main").css("height", temp + "px");
        $("#panel_main").fadeIn(1000);
		$.get( "pages.php?module=web_services&function=create_panel1&id_benhnhan="+window.idbenhnhan+"&action=index", function( data ) {
		  $( ".patient_info" ).html( data );
		  $( ".patient_info" ).css("width", $( "#patient_info" ).width()+"css");	
		});
		/*$.post('pages.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_thanhtoan&idluotkham=<?=$_GET['idluotkham']?>').done(function(data){
			var datacheck=$.trim(data);
			alert_khoa(datacheck);
		})*/

		/*$.post('pages.php?module=<?= $modules ?>&view=<?= $view ?>&action=data_PhuThuThucHienTaiNha&idluotkham='+window.idluotkham).done(function(data) {
		 	window.phuthu=jQuery.parseJSON(data);
		});*/
		$.post('pages.php?module=<?=$modules?>&view=<?=$view?>&action=data_chung&idluotkham='+window.idluotkham).done(function(data) {
			data=data.split('|||');
			window.grid_databs= data[0];
			window.phuthu=jQuery.parseJSON(data[1]);
			alert_khoa($.trim(data[2]));
			
			var rs=data[3].split(';;');
			$("#mabenhnhan").val(rs[2]);
			window.emr_MaBenhNhan=rs[2];
			parent.postMessage('changetitle;<?=$view?>_'+window.idluotkham+';Chỉ định khám - '+rs[3]+';', '*');
			parent.postMessage('changetitle;chidinhkham-tab;Chỉ định khám - '+rs[3]+';', '*');
		});
		/*$.ajax({
		  url: 'pages.php?module=<?= $modules ?>&view=<?= $view ?>&action=data_benhnhanby_idluotkham&id='+window.idluotkham,
		  context: document.body
		}).done(function(data) {
			var rs=data.split(';;');
			$("#mabenhnhan").val(rs[2]);
			
			parent.postMessage('changetitle;<?=$view?>_'+window.idluotkham+';Chỉ định khám - '+rs[3]+';', '*');
			parent.postMessage('changetitle;chidinhkham-tab;Chỉ định khám - '+rs[3]+';', '*');
		});*/
		$("#btn_chidinh,#btn_luu,#btn_sapxep_hangmuc").button();
		load_select_nguoichidinh();
		load_select_trangthai();
		load_select_tennhomcha();
		load_select_bophanthuchien();
        create_layout();
        create_grid();
        create_grid2();
        create_grid3();
		create_goikham();
		create_loaikham();
        resize_control();

        $("#btn_sapxep_hangmuc").click(function(e) {//window.idluotkham
            goiloa_dialog_main("Chỉnh sửa thứ tự khám của bệnh nhân ", 830, 450, "pages.php?module=web_services&view=sapxep_thutu_thuchien_hangmuckham&action=index&id_form=41&type=test&id_luotkham=" + window.idluotkham);
        });
		
		document.getElementById("xemtatca").checked=true;
		var luot =0;
		$('#btn_xemin,#btn_in, #btn_luu,#chongoikham,#hentrakq,#btn_chidinh,#dieutriphoihop').button();
		$('body').bind('keydown', function (e) {
			if(jwerty.is("ctrl+shift+f",e)){
				if(window.chophepluu==0){
					//console.log(1);
					$('#btn_luu').button('enable');
					window.chophepluu=1;
				}else{
					//console.log(2);
					$('#btn_luu').button('disable');
					window.chophepluu=0;
				}
			}
		});
		
		//$("#rowed4").jqGrid('setGridParam',{datatype: 'json',url:"pages.php?module=<?=$modules?>&view=<?=$view?>&action=data_hangmucloaikham_all&trangthaikham="+window.n_trangthaikham+"&idluotkham="+window.idluotkham+"&phantram="+window.phantram+'&nguoinuocngoai='+window.n_nguoinuocngoai+'&doituong='+window.loaidoituongkham}).trigger('reloadGrid');
		$("#xemtatca").change(function(event) {
			if($("#xemtatca").is(':checked')==true){
				$("#gs_TenLoaiKham").focus();
				$("#gs_TenLoaiKham").val("");
				$("#rowed4").jqGrid('setGridParam',{datatype: 'json',url:"pages.php?module=<?=$modules?>&view=<?=$view?>&action=data_hangmucloaikham_all&trangthaikham="+window.n_trangthaikham+"&idluotkham="+window.idluotkham+"&phantram="+window.phantram+'&nguoinuocngoai='+window.n_nguoinuocngoai+'&doituong='+window.loaidoituongkham}).trigger('reloadGrid');
			}else{
				id = $('#rowed3').jqGrid ('getGridParam', 'selrow');	
				var rowData = $("#rowed3").getRowData(id); 
				var ID_NhomCLS = rowData['ID_NhomCLS'];// alert(ID_LuotKham);	
				$("#gs_TenLoaiKham").val("");
				$('#rowed3 #'+id).focus();				 
				$("#rowed3").jqGrid("setSelection",id, true);
				$("#rowed4").jqGrid('setGridParam',{datatype: 'json',url:"pages.php?module=<?=$modules?>&view=<?=$view?>&action=data_hangmucloaikham_idnhomcls&trangthaikham="+window.n_trangthaikham+"&id="+ID_NhomCLS+"&idluotkham="+window.idluotkham+"&phantram="+window.phantram+'&nguoinuocngoai='+window.n_nguoinuocngoai+'&doituong='+window.loaidoituongkham}).trigger('reloadGrid');
			}
		});
	$("#rowed5").jqGrid('setGridParam',{datatype: 'json',url:"pages.php?module=<?=$modules?>&view=<?=$view?>&action=data_khamby_idluotkham&id="+window.idluotkham}).trigger('reloadGrid');
		$("#hentrakq").click(function(e){
			$.post('pages.php?module=web_services&function=get_link&action=index&folder=hen_tra_ket_qua:').done(function(data) {
				elem=1 + Math.floor(Math.random() * 1000000000);
				width=90;
				height=90;
				var folder= data.split(';');
				var links='pages.php?module=canlamsang&view=hen_tra_ket_qua&id_form=&idluotkham='+window.idluotkham;				  				  
				dialog_add_dm("",width,height,elem,links);   
			})
		})
		$("#ghichu").click(function(e){
			elem = 1 + Math.floor(Math.random() * 1000000000);
    		dialog_main("Ghi chú của bệnh nhân: "+ $("#hotenbenhnhan").val(), 95, 70, elem, 'pages.php?module=hanhchinh&view=ghi_chu&id_form=230&idbenhnhan=' + $("#idbenhnhan").val());
		})
        $(window).resize(function() {
            temp = jQuery(window).height() - 125;
            $("#panel_main").css("height", temp + "px");
            resize_control();
        })
		$('#dialog').dialog({
                autoOpen: false,
				width: 400,
                modal: true,
                resizable: false,
                buttons: {
                    "Ok": function() {
                        $("#rowed5").jqGrid('setRowData',$("#idk").val(),{ThanhTienVienPhi:0});
						$("#rowed5").jqGrid('setRowData',$("#idk").val(),{ThanhTienBHYT:0});
						$("#rowed5").jqGrid('setRowData',$("#idk").val(),{PhiThucHien:0});
						$("#rowed5").jqGrid('setRowData',$("#idk").val(),{HoTro:0});
						$("#rowed5").jqGrid('setRowData',$("#idk").val(),{BNChiTra:0});
						$("#rowed5").jqGrid('setRowData',$("#idk").val(),{TrangThai:"HuyBo"});
						$("#rowed5").jqGrid('setRowData',$("#idk").val(),{LyDoHuyBo:$("#lydohuybo").val()});
						$("#rowed5").jqGrid('setRowData',$("#idk").val(),{Huy:1});
						$("#rowed5").jqGrid('setRowData',$("#idk").val() , '', { background: '#A9A9AA',border:'1px solid #BBBBBB' });
						jQuery("#rowed5").jqGrid('saveRow',$("#idk").val());
						var tmp5 = $("#rowed5").jqGrid('getDataIDs'); 
						var tt_bhyt =0;
						var tt_vienphi =0;
						var phithuchien =0;
						for(var i=0;i < tmp5.length;i++){ 
							var rowData = $("#rowed5").getRowData(tmp5[i]);
							xoa = "<input class=' custom_button_n' style='height:22px;width:50px; box-shadow:none!important; cursor:pointer;' type='button' value='Xóa' onclick=\"n_xoa('"+tmp5[i]+"');\" />"; 
							$("#rowed5").jqGrid('setRowData',tmp5[i],{Xoa:xoa});	
							tt_vienphi =parseFloat(tt_vienphi) + parseFloat(rowData["ThanhTienVienPhi"]);
							tt_bhyt =parseFloat(tt_bhyt) + parseFloat(rowData["ThanhTienBHYT"]);
							phithuchien =parseFloat(phithuchien) + parseFloat(rowData["PhiThucHien"]);
						}
						$("#thanhtienvienphi").val(formatMoney(tt_vienphi));
						$("#thanhtienbhyt").val(formatMoney(tt_bhyt));
						$("#phithuchien").val(formatMoney(phithuchien));
						tinhtongtien();
                        $(this).dialog("close");
                    },
                    "Cancel": function() {
                        $(this).dialog("close");
                    }
                }
            });
			
			$('#dialog_loi').dialog({
                autoOpen: false,
                width: 350,
				height:150,
                modal: true,
                resizable: false,
				closeOnEscape: true,
				buttons: {
					"Ok": function() {
						$( this ).dialog( "close" );
					}
				}
            });

			$('#comfrim').dialog({
                autoOpen: false,
                width: 350,
				height:150,
                modal: true,
                resizable: false,
				closeOnEscape: true,
				focus: function() {
					$('#comfrim').parent().find('.ui-dialog-buttonpane button:eq(0)').focus();
				},
				buttons: {
					"Ok": function() {
						$( this ).dialog( "close" );
					},
					"can": function() {
						$( this ).dialog( "close" );
					}
				}
            });

		if(window.idluotkham==""){
			$( "#dialog_loi" ).dialog('open');
		}
		$("input#btn_cdmoi").attr("disabled", true);
		//$( "#btn_chidinh" ).addClass( "ui-state-disabled" );
			$( ".data_chongoikham" ).dialog({
			  autoOpen: false,
			  height: 500,
			  width: 1035,
			  modal: true,
			  buttons: {
				"<?php lang('chon')?>": function() {
						var i,j,tmp,tmp1;
						var tmpn = jQuery("#data_loaikham").jqGrid('getGridParam','selarrrow');
						for(i=0;i<tmpn.length;i++){
							var rowData = jQuery('#data_loaikham').jqGrid ('getRowData', tmpn[i]);
							ChuyenCD(rowData['GiaTheoBaoHiem'],rowData['PhanTramCungChiTra'],rowData['GiaHienThi'],rowData['HoTro'],rowData['ID_LoaiKham'],rowData['TenLoaiKham'],rowData['GiaBaoChoBN'],rowData['GiaPhuThu'],rowData['GiaThueNgoaiThucHien'],rowData['IDPhongChuyenMon'],window.emr_MaBenhNhan,rowData['ID_NhomCLS'],'',rowData['ThoiGianTrungBinhThucHien'],rowData['Color'],rowData['TenBHYT']);
						}
					$( this ).dialog( "close" );
				  },
				Cancel: function() {
				  $( this ).dialog( "close" );
				}
			  },
			  close: function() {
			  }
			});

		  $( "#chongoikham" ).click(function() {
		  $('.data_chongoikham').dialog('open');
		});

//f12 luu
document.onkeydown = function(e) {
	if (e.keyCode === 123) {
		$("#btn_chidinh").click();
		return false;
	}
};
$(document).keyup(function(e) {
    if(jwerty.is("ctrl+s",e)){
		$("#btn_luu").click();
		return false;
	}
});

// Phong ho khi loi luu de co the cho thuc hien luu lai
$(document).keyup(function(e) {
    if(jwerty.is("ctrl+shift+alt",e)){
		window.chidinhlandau=0;
	}
});
window.inphieu=0;
window.chidinhlandau=0;
//$('#btn_luu').button('disable');
$("#btn_xemin").click(function(){
	$('#btn_xemin').button('disable');
	window.inphieu=1;
	saveData(1,0);
});
$("#btn_in").click(function(){
	window.n_incd=1;
	$('#btn_in').button('disable');
	window.inphieu=1;
	saveData(1,0);
});
$("#btn_in").dblclick(function(e) {
    alert("Vui lòng không click nhiều lần.\nXin cám ơn!");
});
$("#btn_in").dblclick(function(e) {
    alert("Vui lòng không click nhiều lần.\nXin cám ơn!");
});
$("#btn_luu").click(function(){
	saveData(0,1);
})//$("#btn_luu")
$("#btn_chidinh").dblclick(function(e) {
    alert("Vui lòng không click nhiều lần.\nXin cám ơn!");
});
$("#btn_chidinh").click(function(){
	//if(window.chidinhlandau==0){
	//	window.chidinhlandau=1;
	saveData(1,1);
	//}
})//$("#btn_luu")

$("#btn_cddatra").change(function() {
	if($(this).is(':checked')==true){
	var tmp = $("#rowed5").jqGrid('getDataIDs');
			for (var i = 0; i < tmp.length; i++)
			{
				var rowData = jQuery('#rowed5').jqGrid ('getRowData', tmp[i]);
				if(rowData['TrangThai']=='HuyBo'){
					$("#"+tmp[i]).show();
				}
			}
	}else{
		var tmp = $("#rowed5").jqGrid('getDataIDs');
		for (var i = 0; i < tmp.length; i++)
		{
			var rowData = jQuery('#rowed5').jqGrid ('getRowData', tmp[i]);
			if(rowData['TrangThai']=='HuyBo'){
				$("#"+tmp[i]).hide();
			}
		}
	}
})

$("#btn_cdmoi").change(function() {
	if($(this).is(':checked')==true){
	$("#btn_cddatra").attr("disabled", true);
	var tmp = $("#rowed5").jqGrid('getDataIDs');
		for (var i = 0; i < tmp.length; i++){
			var rowData = jQuery('#rowed5').jqGrid ('getRowData', tmp[i]);
			if(rowData['Luu']==1){
				$("#"+tmp[i]).hide();
			}
		}
	}else{
		$("#btn_cddatra").removeAttr("disabled");
		var tmp = $("#rowed5").jqGrid('getDataIDs');
		for (var i = 0; i < tmp.length; i++){
			var rowData = jQuery('#rowed5').jqGrid ('getRowData', tmp[i]);
			if(rowData['Luu']==1){
				$("#"+tmp[i]).show();
			}
		}
	}
})
phanquyen();
})//end ready
var lastsel;
function create_grid() {
        $("#rowed3").jqGrid({
            url: 'pages.php?module=<?= $modules ?>&view=<?= $view ?>&action=data_nhomloaikham',
            datatype: "json",
            colNames: ['id nhóm cha','id nhóm', '<?php lang('nhom')?>', 'Tên nhóm cha'],
            colModel: [
                {name: 'IDNhomCha', index: 'IDNhomCha', width: "0%", editable: false, align: 'left', hidden: true,edittype:"select",formatter:'select',editoptions:{value: tennhomcha}},
				{name: 'ID_NhomCLS', index: 'ID_NhomCLS', width: "0%", editable: false, align: 'left', hidden: true},
                {name: 'TenNhom', index: 'TenNhom', search: false, width: "1%", editable: false, align: 'left', hidden: false, classes:'rowed3_event'},
				{name: 'TenNhomCha', index: 'TenNhomCha', width: "2%", editable: false, align: 'left', hidden: true},
				//{name: 'STT', index: 'STT', width: "0%", editable: false, align: 'left', hidden: true},
            ],
           loadonce: false,
            scroll: 1,
            modal: true,
            rowNum: 100,
            rowList: [30, 50, 70],
            pager: '#prowed3',
            height: 100,
            width: 100,
            viewrecords: true,
            ignoreCase: true,
            shrinkToFit: true,
			grouping:true,
		  	groupingView : {
			groupField : ['IDNhomCha'],
			groupDataSorted : true ,
			groupCollapse : false,
			groupColumnShow :false,
			groupText : ['<b>{0}</b>']
		 	 },
			afterShowForm : function (formid) {

			},
            onSelectRow: function(id) {
				var luot= $("#soluotchon").val();
				$("#soluotchon").val(1);
				if(luot==1){
					document.getElementById("xemtatca").checked=false;
				}
				var rowData = jQuery(this).getRowData(id);
				var ID_NhomCLS = rowData['ID_NhomCLS'];// alert(ID_LuotKham);
				$("#rowed4").jqGrid('setGridParam',{datatype: 'json',url:"pages.php?module=<?=$modules?>&view=<?=$view?>&action=data_hangmucloaikham_idnhomcls&trangthaikham="+window.n_trangthaikham+"&id="+ID_NhomCLS+"&idluotkham="+window.idluotkham+"&phantram="+window.phantram+'&nguoinuocngoai='+window.n_nguoinuocngoai+'&doituong='+window.loaidoituongkham}).trigger('reloadGrid');
            },
            ondblClickRow: function(rowId, rowIndex, columnIndex) {
				setTimeout(function(){
					var tmp = $("#rowed4").jqGrid('getDataIDs');
					console.log(tmp.length);
					if(tmp.length==1){
						var rowData = jQuery('#rowed4').jqGrid ('getRowData', tmp[tmp.length-1]);
						ChuyenCD(rowData['GiaTheoBaoHiem'],rowData['PhanTramCungChiTra'],rowData['GiaHienThi'],rowData['HoTro'],rowData['ID_LoaiKham'],rowData['TenLoaiKham'],rowData['GiaBaoChoBN'],rowData['GiaPhuThu'],rowData['GiaThueNgoaiThucHien'],rowData['IDPhongChuyenMon'],window.emr_MaBenhNhan,rowData['ID_NhomCLS'],rowData['NhomThucHien'],rowData['ThoiGianTrungBinhThucHien'],rowData['Color'],rowData['TenBHYT']);
					}
				},300);
            },
            onselect: function(rowId, rowIndex, columnIndex) {

            },
            loadComplete: function(data) {
			ids = $('#rowed3').jqGrid('getDataIDs');
			//$("#rowed3").jqGrid("setSelection",ids[0], true);
			 var i, groups = $(this).jqGrid("getGridParam", "groupingView").groups,
			 l = groups.length,
			 idSelectorPrefix = "#" + this.id + "ghead_0_";
			 for (i = 0; i < l; i++) {
				 if (groups[i].cnt === 1) {
					 // hide the grouping row
					 $(idSelectorPrefix + i).hide();
				 }
			 }
					$("#gs_TenLoaiKham").focus();
					$("#rowed3").unbind("keydown")
					$("#rowed3").jqGrid('bindKeys', {});
					$("#rowed3").bind("keydown",function(event) {
					 var keycode = (event.keyCode ? event.keyCode : event.which);
					 if(keycode == '13'){
						var tmp = $("#rowed4").jqGrid('getDataIDs');
						if(tmp.length==1){
							var id = $("#rowed3").jqGrid ('getGridParam', 'selrow');
							$("#rowed3 #"+id).dblclick();
						}else{
							$("#gs_TenLoaiKham").focus();
							}
					 }
					 })
			},
            caption: "<?php lang('nhomlk')?>"
        });
        $("#rowed3").jqGrid('navGrid', "#prowed3", {add: false, edit: false, del: false, search: false, refresh: true, closeAfterEdit: true, clearAfterAdd: true, navkeys: [true, 38, 40], closeOnEscape: true});
	$("#rowed3").jqGrid('bindKeys', {});
    }
function create_grid2(){
	mydata=[];
	$("#rowed4").jqGrid({
		data: mydata,
		datatype: "local",
		colNames: ['GiaThueNgoaiThucHien', 'ThoiGianTrungBinhThucHien', 'ID_DMLoaiKham_Phongban','ID_LoaiKham', '<?php lang('tenlk')?>', '<?php lang('giavp')?>', '<?php lang('giavp')?>','<?php lang('giabhyt')?>','P.Thu BV','P.Thu tại nhà','Hệ số người nước ngoài','<?php lang('bhyttra')?>','Color','','','<?php lang('hotro')?>','TenBHYT'],
		colModel: [
			{name: 'GiaThueNgoaiThucHien', index: 'GiaThueNgoaiThucHien', search: false, width: "30%", editable: false, align: 'left', hidden: true},
			{name: 'ThoiGianTrungBinhThucHien', index: 'ThoiGianTrungBinhThucHien', search: false, width: "30%", editable: false, align: 'left', hidden: true},
			{name: 'ID_DMLoaiKham_Phongban', index: 'ID_DMLoaiKham_Phongban', search: false, width: "30%", editable: false, align: 'left', hidden: true},
			{name: 'ID_LoaiKham', index: 'ID_LoaiKham', search: false, width: "0%", editable: false, align: 'left', hidden: true},
			{name: 'TenLoaiKham', index: 'TenLoaiKham', search: true, width: "70%", editable: false, align: 'left', hidden: false,cellattr: function (rowId, val, rawObject) {
				//console.log(rawObject);
			  if(rawObject['TenBHYT']){
        			tenbh=rawObject['TenBHYT'];
        		}else if(rawObject[16]){
        			tenbh=rawObject[16];
        		}else{
        			tenbh="";
        		}

            	//console.log(rawObject['TenBHYT']);
		    	return tenbh === "" ? ' title="Tên BHYT: Không có"' : ' title="Tên BHYT: '+tenbh+'"';
			}},
			{name:'GiaBaoChoBN',index:'GiaBaoChoBN', width:"39%", editable:true,align:'right',edittype:"text",hidden:true,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
			{name:'GiaHienThi',index:'GiaHienThi', width:"39%", editable:true,align:'right',edittype:"text",hidden:false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
			{name:'GiaTheoBaoHiem',index:'GiaTheoBaoHiem', width:"32%", editable:true,align:'right',edittype:"text",hidden:false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
			{name:'GiaPhuThu',index:'GiaPhuThu', width:"28%", editable:true,align:'right',edittype:"text",hidden:true,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
			{name:'GiaPhuThuTaiNha',index:'GiaPhuThuTaiNha', width:"30%", editable:true,align:'right',edittype:"text",hidden:true,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
			{name:'HeSoNuocNgoai',index:'HeSoNuocNgoai', width:"30%", editable:true,align:'right',edittype:"text",hidden:true,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
			{name:'GiaBaoHiemChiTra',index:'GiaBaoHiemChiTra', width:"30%", editable:true,align:'right',edittype:"text",hidden:true,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
			{name: 'Color', index: 'Color', search: false, width: "0%", editable: false, align: 'left', hidden: true},
			{name: 'NhomBHYT', index: 'NhomBHYT', search: false, width: "0%", editable: false, align: 'left', hidden: true},
			{name: 'PhanTramCungChiTra', index: 'PhanTramCungChiTra', search: false, width: "0%", editable: false, align: 'left', hidden: true},
			{name: 'HoTro', index: 'HoTro', width:"30%", editable:true,align:'right',edittype:"text",hidden:true,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
			{name: 'TenBHYT', index: 'TenBHYT', search: false, width: "0%", editable: false, align: 'left', hidden: true},
			],
		loadonce: true,
		scroll: 1,
		modal: true,
		shrinkToFit: true,
		grid_save_option: "",
		cmTemplate: {sortable: false},
		rowNum: 300,
		rowList: [],
		pager: '#prowed3',
		height: 100,
		width: 100,
		viewrecords: true,
		ignoreCase: true,
		sortorder: "desc",
		afterShowForm : function (formid) {

		},
		 onSelectRow: function(id) {

		},
		ondblClickRow: function(rowId, rowIndex, columnIndex) {
			console.log(rowId);
			if(rowId==3905){
				cholesterol=0;
				triglycerite=0;
				var tmp1 = $("#rowed5").jqGrid('getDataIDs');
				for(var i=0;i < tmp1.length;i++){
					var rowData = $("#rowed5").getRowData(tmp1[i]);
					//console.log(rowData['IDLoaiKham']);
					if(rowData['IDLoaiKham']==3770)
						cholesterol=1;
					if(rowData['IDLoaiKham']==3771)
						triglycerite=1;
				}
				if(cholesterol==1 && triglycerite==1){
					//chuyen(rowId);
					var rowData = jQuery("#rowed4").getRowData(rowId);
					ChuyenCD(rowData['GiaTheoBaoHiem'],rowData['PhanTramCungChiTra'],rowData['GiaHienThi'],rowData['HoTro'],rowData['ID_LoaiKham'],rowData['TenLoaiKham'],rowData['GiaBaoChoBN'],rowData['GiaPhuThu'],rowData['GiaThueNgoaiThucHien'],rowData['IDPhongChuyenMon'],window.emr_MaBenhNhan,rowData['ID_NhomCLS'],rowData['NhomThucHien'],rowData['ThoiGianTrungBinhThucHien'],rowData['Color'],rowData['TenBHYT']);
				}else{
					alert("Vui lòng kích chỉ định Cholesterol và Triglycerite trước khi kích chỉ định này!");
				}
			}else if(rowId==3780){
				creatinin=0;
				var tmp1 = $("#rowed5").jqGrid('getDataIDs');
				for(var i=0;i < tmp1.length;i++){
					var rowData = $("#rowed5").getRowData(tmp1[i]);
					console.log(rowData['IDLoaiKham']);
					if(rowData['IDLoaiKham']==3779)
						creatinin=1;
				}
				if(creatinin==1){
					//chuyen(rowId);
					var rowData = jQuery("#rowed4").getRowData(rowId);
					ChuyenCD(rowData['GiaTheoBaoHiem'],rowData['PhanTramCungChiTra'],rowData['GiaHienThi'],rowData['HoTro'],rowData['ID_LoaiKham'],rowData['TenLoaiKham'],rowData['GiaBaoChoBN'],rowData['GiaPhuThu'],rowData['GiaThueNgoaiThucHien'],rowData['IDPhongChuyenMon'],window.emr_MaBenhNhan,rowData['ID_NhomCLS'],rowData['NhomThucHien'],rowData['ThoiGianTrungBinhThucHien'],rowData['Color'],rowData['TenBHYT']);
				}else{
					alert("Vui lòng kích chỉ định Creatinin trước khi kích chỉ định này!");
				}
			}else{
				//chuyen(rowId);
				var rowData = jQuery("#rowed4").getRowData(rowId);
					ChuyenCD(rowData['GiaTheoBaoHiem'],rowData['PhanTramCungChiTra'],rowData['GiaHienThi'],rowData['HoTro'],rowData['ID_LoaiKham'],rowData['TenLoaiKham'],rowData['GiaBaoChoBN'],rowData['GiaPhuThu'],rowData['GiaThueNgoaiThucHien'],rowData['IDPhongChuyenMon'],window.emr_MaBenhNhan,rowData['ID_NhomCLS'],rowData['NhomThucHien'],rowData['ThoiGianTrungBinhThucHien'],rowData['Color'],rowData['TenBHYT']);
			}

		},
		onRightClickRow: function(rowid, iRow, iCol, e) {

		},
		loadComplete: function(data) {
			grid_filter_enter("#rowed4");
			$("#rowed4").unbind("keydown")
			$("#rowed4").jqGrid('bindKeys', {});
			$("#rowed4").bind("keydown",function(event) {
				var keycode = (event.keyCode ? event.keyCode : event.which);
				if(keycode == '13'){
					var id = $("#rowed4").jqGrid ('getGridParam', 'selrow');
					$("#rowed4 #"+id).dblclick();
				}
			});
			var tmp1 = $("#rowed4").jqGrid('getDataIDs');
			for(var i=0;i < tmp1.length;i++){
				var rowData = $("#rowed4").getRowData(tmp1[i]);
				//if(window.loaidoituongkham=="BHYT"){
					if(rowData["Color"]=="1" ){
						$("#rowed4").jqGrid('setRowData', tmp1[i], false, { background: '#C5F7C1',border:'1px solid #dfd9c3' });
					}else if(rowData["Color"]=="2"){
						$("#rowed4").jqGrid('setRowData', tmp1[i], false, { background: '#FDFCC2',border:'1px solid #dfd9c3' });
					}else if(rowData["Color"]=="3"){
						$("#rowed4").jqGrid('setRowData', tmp1[i], false, { background: '#DE5145',border:'1px solid #dfd9c3' });
					}
				//}
			}
		},
		caption: "<?php lang('hangmuclk')?><div id='xtc' style='float:right; margin-left: 50px;'><input type='checkbox' id='xemtatca'  /><?php lang('xemtc')?></div>"
	});
	$("#rowed4").jqGrid('filterToolbar',{searchOperators : false,searchOnEnter:false,defaultSearch:"cn"});
	$("#rowed4").jqGrid('navGrid', "#prowed4", {add: false, edit: false, del: false, search: false, refresh: true, closeAfterEdit: true, clearAfterAdd: true, navkeys: [true, 38, 40], closeOnEscape: true});
	$("#rowed4").jqGrid('bindKeys', {});
	add_namclass();
   }
function create_grid3()
    {
		mydata=[];
        $("#rowed5").jqGrid({
            data: mydata,
            datatype: "local",
            colNames: ['<?php lang('bhcd')?>','ID Loại Khám','<?php lang('xoa')?>','<?php lang('loaikham')?>', 'Đ.Giá V.Phí', '<?php lang('giabhyt')?>', '<?php lang('phuthu')?>', 'TT V.Phí', '<?php lang('ttbhyt')?>','BH trả','<?php lang('hotro')?>','<?php lang('bntra')?>', '<?php lang('phithien')?>', '<?php lang('trangthaicd')?>', '<?php lang('thuchien')?>', 'Bộ phận thực hiện', '<?php lang('nguoicd')?>', '<?php lang('nguoicd')?>',  'GiaThueNgoaiThucHien',  'ThoiGianTrungBinhThucHien',  'IDKham',  'MaBenhNhan','LyDoHuyBo','huy',  'IDLuotKham','Luu','IDNhomCLS','NgayGioTao','Lần chỉ định','XetNghiem','% cùng chi trả','TT cùng chi trả','Color','','','Code','','TenBHYT'],
            colModel: [
				{name:'FixGiaBHYT',index:'FixGiaBHYT', width:"3%",stype: 'text',search:true,searchoptions: { sopt: ['eq', 'ne'],value:':;1:Có;0:Không'}, editable:true,align:'center',hidden:false,edittype:"checkbox",formatter:"checkbox",formatoptions:{disabled: false},formoptions:{ rowpos:13, colpos:1}
			,editoptions: { value:"1:0",dataEvents:  [{ type: 'click', fn: function(e) { 
				$("#rowed5 tbody").addClass('bongmo');
				$("#rowed5 tbody").find('input:checkbox').each(function(index, element) {
                    $("#"+element.id).prop('disabled',true);
                });

				if($("#"+$(e.target).attr('id')).is(':checked')){
   					var tthai=1;
   				}
				else{
  					var tthai=0;
  				}
				var row = $(e.target).closest('tr.jqgrow');
                var tam = row.attr('id');
               var IDKham= $('#rowed5').getCell(tam, 'IDKham');
			   if(IDKham==''){
				 //  alert('Hiện tại chức năng này chỉ thực hiện các chỉ định đã lưu');
				   tooltip_message("Chức năng này chỉ thực hiện trên các chỉ định đã được lưu");
				   $("#rowed5 tbody").removeClass('bongmo');
					$("#rowed5 tbody").find('input:checkbox').each(function(index, element) {
						$("#"+element.id).prop('disabled',false);
					});
					if($("#"+$(e.target).attr('id')).is(':checked')){
						$("#"+$(e.target).attr('id')).prop('checked',false);
					}else{
						$("#"+$(e.target).attr('id')).prop('checked',true);
					}
			   }else{
				   //$.post('pages.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_thanhtoan&idluotkham=<?=$_GET['idluotkham']?>').done(function(data){
						//var datacheck=$.trim(data);
						//if((datacheck=='0' || datacheck=='5') && window.n_dathanhtoanbill!=1){
							$.post('pages.php?module=<?= $modules ?>&view=<?= $view ?>&action=controller_fix_bhyt&hienmaloi=a&id_kham='+tam+'&ac='+tthai).done(function(data) {
								data=$.parseJSON(data);
								if(data.IsLock==1){
									$("#rowed5 tbody").removeClass('bongmo');
									$("#rowed5 tbody").find('input:checkbox').each(function(index, element) {
										$("#"+element.id).prop('disabled',false);
									});

									alert(data.Notes);
									if($("#"+$(e.target).attr('id')).is(':checked')){
										$("#"+$(e.target).attr('id')).prop('checked',false);
									}else{
										$("#"+$(e.target).attr('id')).prop('checked',true);
									}
								}else{
									//var n_rs=data.split(';;');
									$("#rowed5 tbody").removeClass('bongmo');
									$("#rowed5 tbody").find('input:checkbox').each(function(index, element) {
										$("#"+element.id).prop('disabled',false);
									});

									//alert(parseInt(n_rs[2]));
									$("#rowed5").jqGrid('setCell',tam,'BNChiTra', parseInt(data.PhiThucHien)-parseInt(data.ThanhTienBaoHiem)-parseInt(data.HoTro));
									$("#rowed5").jqGrid('setCell',tam,'ThanhTienBHYT', parseInt(data.ThanhTienBaoHiem));
									$("#rowed5").jqGrid('setCell',tam,'BHChiTra', parseInt(data.ThanhTienBaoHiem));
									$("#rowed5").jqGrid('setCell',tam,'HoTro', parseInt(data.HoTro));
									$("#rowed5").jqGrid('setCell',tam,'PhanTramCungChiTra', parseInt(data.PhanTramCungChiTra));
									$("#rowed5").jqGrid('setCell',tam,'ThanhTienCungChiTra', parseInt(data.ThanhTienCungChiTra));
									if(data.Isbhyt==0){
										$("#"+tam+"_FixGiaBHYT").prop('checked',false);
									}
									//alert(n_rs[7]);
									if(data.KetQua==1){
										alert("Lượt khám này đã hỗ trợ BHYT >=200.000đ.");
									}else if(data.KetQua==2){
										alert("Lượt khám này đã hỗ trợ BHYT >=400.000đ nên không được hỗ trợ thêm, vui lòng làm bệnh án nội trú bằng cách (nhấn vào nút phiếu vào viện) trong form bệnh án.");
									}
									tinhtongtien();
								}
							});
						/*}else{
							$("#rowed5 tbody").removeClass('bongmo');
							$("#rowed5 tbody").find('input:checkbox').each(function(index, element) {
								$("#"+element.id).prop('disabled',false);
							});

							alert_khoa(datacheck);
							if($("#"+$(e.target).attr('id')).is(':checked')){
								$("#"+$(e.target).attr('id')).prop('checked',false);
							}else{
								$("#"+$(e.target).attr('id')).prop('checked',true);
							}
							//tooltip_message("Lượt khám này đã thanh toán");
							//$("#thongbao").html("Thông báo: Lượt khám này đã thanh toán");
						}
					});*/
			   }

                 } }]}},
                {name: 'IDLoaiKham', index: 'IDLoaiKham', search: false, width: "10%", editable: false, align: 'left', hidden: true},
                {name: 'Xoa', index: 'Xoa', search: false, width: "4%", editable: false, align: 'left', hidden: false},
                {name: 'LoaiKham', index: 'LoaiKham', search: false, width: "20%", editable: false, align: 'left', hidden: false,classes:'loai_kham',cellattr: function (rowId, val, rawObject) {
					if(rawObject['TenBHYT']){
            			tenbh=rawObject['TenBHYT'];
            		}else{
            			tenbh=rawObject[37];
            		}
                	//console.log(rawObject['TenBHYT']);
			    	return tenbh === "" ? ' title="Tên BHYT: Không có"' : ' title="Tên BHYT: '+tenbh+'"';
			}},
                {name: 'DonGiaVienPhi', index: 'DonGiaVienPhi', search: false, width: "12%", editable: false, align: 'right', hidden: true,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
				{name: 'DonGiaBHYT', index: 'DonGiaBHYT', search: false, width: "12%", editable: false, align: 'right', hidden: false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
				{name: 'PhuThu', index: 'PhuThu', search: false, width: "8%", editable: false, align: 'right', hidden: true,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
				{name: 'ThanhTienVienPhi', index: 'ThanhTienVienPhi', search: false, width: "9%", editable: false, align: 'right', hidden: true,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
				{name: 'ThanhTienBHYT', index: 'ThanhTienBHYT', search: false, width: "10%", editable: false, align: 'right', hidden: true,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},

				{name: 'BHChiTra', index: 'BHChiTra', search: false, width: "9%", editable: false, align: 'right', hidden: false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
				{name: 'HoTro', index: 'HoTro', search: false, width: "9%", editable: false, align: 'right', hidden: false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
				{name: 'BNChiTra', index: 'BNChiTra', search: false, width: "9%", editable: false, align: 'right', hidden: false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
                {name: 'PhiThucHien', index: 'PhiThucHien', search: false, width: "9%", editable: false, align: 'right', hidden: false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
                {name: 'TrangThai', index: 'TrangThai', search: false, width: "9%", editable: false, align: 'center', hidden: false,edittype:"select",formatter:'select',editoptions:{value: trangthai}},
                {name: 'ThucHien', index: 'ThucHien', search: false, width: "12%", editable: true, align: 'center', hidden: true,edittype:"select",formatter:'select',editoptions:{value:"0:Hospital;1:Home;2:Self",dataEvents: [{ type: 'change keyup', fn: function(e) {
					var tmp5 = $("#rowed5").jqGrid('getDataIDs');
					var row = $(e.target).closest('tr.jqgrow');
					var rowId = row.attr('id');
					var id_loaikham =$('#rowed5').jqGrid('getCell',rowId,'IDLoaiKham');
					var LoaiKham =$('#rowed5').jqGrid('getCell',rowId,'LoaiKham');
					//console.log(id_loaikham+':'+LoaiKham);
					var id_ncls =$('#rowed5').jqGrid('getCell',rowId,'IDNhomCLS');
					var BHChiTra =$('#rowed5').jqGrid('getCell',rowId,'BHChiTra');
					$("#rowed5").jqGrid('setCell',rowId,'Sua', '1');
					var y=0;
					var yy=0;
					var n=0;
					var x=0;
					var a="";
					for(var i = 0; i < phuthu.length; i++) {
						if(phuthu[i]['id'] == id_loaikham) {
							 y=i;
							// alert(id_loaikham+'+++'+phuthu[i]['id']);
							 break;
						}
					}
					for(var k = 0; k < tmp5.length; k++){
						var rowData = $("#rowed5").getRowData(tmp5[k]);
						if((rowData["IDNhomCLS"]==17)&&(x==0)&&($('#'+tmp5[k]+'_ThucHien').val()==1)){
							window.id_rowcls2=tmp5[k];
						//	x++;
						}
					}
					//var x=0;
					for(var l = 0; l < phuthu.length; l++) {
						if((parseInt(phuthu[l]['id'])==parseInt(id_loaikham)) && (parseInt(phuthu[l]['ID_NhomCLS'])==17) && (x==0)){
							n=l;
						//	x++;
							break;
						}
					}
					var thuchien=$('#'+rowId+'_ThucHien').val()
					if((phuthu[i]['DieuTriTaiNha']!=1)&& (thuchien==1)){
						$('#'+rowId+'_ThucHien').val(0);
						$('#'+rowId+'_ThucHien').change();
						alert("Hạng mục khám này không cho phép thực hiện tại nhà");
					}else{
					if(thuchien==0){
						console.log(phuthu[i]['PhuThuThucHienTaiNha']+'__0_'+phuthu[i]['id'])
						 if((window.loaidoituongkham=="BHYT") && (phuthu[i]["GiaBaoHiem"]>0 )){
								window.thanhtien_vienphi=0;
								window.thanhtien_bhyt=parseInt(phuthu[i]["GiaBaoHiem"])+parseInt(phuthu[i]["GiaPhuThuBenhVien"]);
								window.phithuchien=phuthu[i]["Gia"];
								window.bn_chitra=parseInt(window.phithuchien)-parseInt(BHChiTra);
								if(parseInt(phuthu[i]["HoTro"])>0){
									window.bn_chitra=window.phithuchien-parseInt(phuthu[i]["HoTro"]);
								}
							}else{
								window.thanhtien_vienphi=phuthu[i]["Gia"];//HeSoNuocNgoai
								window.thanhtien_bhyt=0;
								window.phithuchien=phuthu[i]["Gia"];
								window.bn_chitra=0;
							}
						$('#rowed5').jqGrid("setCell", rowId, 'PhiThucHien', window.phithuchien);
						$('#rowed5').jqGrid("setCell", rowId, 'BNChiTra', window.bn_chitra);
					}else if(thuchien==1){
						if (typeof id_rowcls2 === 'undefined'){
							console.log(phuthu[i]['PhuThuThucHienTaiNha']+'__1a_'+phuthu[i]['id'])
							if((window.loaidoituongkham=="BHYT") && (parseFloat(phuthu[i]["GiaBaoHiem"])>0 )){
								window.thanhtien_vienphi=0;
								window.thanhtien_bhyt=parseInt(phuthu[i]["GiaBaoHiem"])+parseInt(phuthu[i]["GiaPhuThuBenhVien"])+parseInt(phuthu[i]['PhuThuThucHienTaiNha']);
								window.phithuchien=parseInt(phuthu[i]["Gia"])+parseInt(phuthu[i]['PhuThuThucHienTaiNha']);
								window.bn_chitra=parseInt(window.phithuchien)-parseInt(BHChiTra);
								if(parseInt(phuthu[i]["HoTro"])>0){
									window.bn_chitra=window.phithuchien-parseInt(phuthu[i]["HoTro"]);
								}
							}else{
								window.thanhtien_vienphi=(parseInt(phuthu[i]["Gia"])+parseInt(phuthu[i]['PhuThuThucHienTaiNha']));
								window.thanhtien_bhyt=0;
								window.phithuchien=window.thanhtien_vienphi;
								window.bn_chitra=0;
							}
						$('#rowed5').jqGrid("setCell", rowId, 'PhiThucHien', window.phithuchien);
						$('#rowed5').jqGrid("setCell", rowId, 'BNChiTra', window.bn_chitra);
						}else if(id_rowcls2){
							for(var i = 0; i< tmp5.length; i++){
								var rowData = $("#rowed5").getRowData(tmp5[i]);
								if((rowData["IDNhomCLS"]==17)&& (tmp5[i]!=rowId) && (id_ncls==17) && ($('#'+tmp5[i]+'_ThucHien').val()!=2)){
									/*$('#'+tmp5[i]+'_ThucHien').val(0);
									$('#'+tmp5[i]+'_ThucHien').change();*/
								}
							}
							if(id_rowcls2==rowId){
								//console.log(phuthu[i]['PhuThuThucHienTaiNha']+'__2_'+phuthu[n]['id'])
									if((window.loaidoituongkham=="BHYT") && (parseInt(phuthu[n]["GiaBaoHiem"])>0 )){
										window.thanhtien_vienphi=0;
										window.thanhtien_bhyt=parseInt(phuthu[n]["GiaBaoHiem"])+parseInt(phuthu[n]["GiaPhuThuBenhVien"])+parseInt(phuthu[n]['PhuThuThucHienTaiNha']);
										window.phithuchien=parseInt(phuthu[n]["GiaPhuThuBenhVien"])+parseInt(phuthu[n]['PhuThuThucHienTaiNha']);
										window.bn_chitra=parseInt(window.phithuchien)-parseInt(BHChiTra);
										if(parseInt(phuthu[n]["HoTro"])>0){
											window.bn_chitra=window.phithuchien-parseInt(phuthu[n]["HoTro"]);
										}
									}else{
										window.thanhtien_vienphi=(parseInt(phuthu[n]["Gia"])+parseInt(phuthu[n]['PhuThuThucHienTaiNha']));
										window.thanhtien_bhyt=0;
										window.phithuchien=window.thanhtien_vienphi;
										window.bn_chitra=0;
									}
								$('#rowed5').jqGrid("setCell", rowId, 'PhiThucHien', window.phithuchien);
								$('#rowed5').jqGrid("setCell", rowId, 'BNChiTra', window.bn_chitra);
							}else{
								//console.log(phuthu[y]['PhuThuThucHienTaiNha']+'__3a_'+phuthu[y]['id']+'__'+phuthu[y]["GiaBaoHiem"])
								//alert(window.loaidoituongkham+'&&'+parseFloat(phuthu[n]["GiaBaoHiem"]));
									if((window.loaidoituongkham=="BHYT") && (parseFloat(phuthu[y]["GiaBaoHiem"])>0 )){
										window.thanhtien_vienphi=0;
										for(var iii = 0; iii < phuthu.length; iii++) {
											if(phuthu[iii]['id'] == id_loaikham) {
												window.thanhtien_bhyt=parseInt(phuthu[iii]["GiaBaoHiem"])+parseInt(phuthu[iii]["GiaPhuThuBenhVien"])+parseInt(phuthu[iii]['PhuThuThucHienTaiNha']);
												window.phithuchien=(parseInt(phuthu[iii]["Gia"])+parseInt(phuthu[iii]['PhuThuThucHienTaiNha']));
												//alert(parseInt(window.phithuchien)+'-'+parseInt(BHChiTra));
												window.bn_chitra=parseInt(window.phithuchien)-parseInt(BHChiTra);
												if(parseInt(phuthu[iii]["HoTro"])>0){
													window.bn_chitra=window.phithuchien-parseInt(phuthu[iii]["HoTro"]);
												}
												break;
											}
										}
									}else{
										for(var iii = 0; iii < phuthu.length; iii++) {
											if(phuthu[iii]['id'] == id_loaikham) {
												window.thanhtien_vienphi=(parseInt(phuthu[iii]["Gia"])+parseInt(phuthu[iii]['PhuThuThucHienTaiNha']));
												window.thanhtien_bhyt=0;
												window.phithuchien=window.thanhtien_vienphi;
											}
										}
										window.bn_chitra=0;
									}
								$('#rowed5').jqGrid("setCell", rowId, 'PhiThucHien', window.phithuchien);
								$('#rowed5').jqGrid("setCell", rowId, 'BNChiTra', window.bn_chitra);
							}
						}else{
							//console.log(phuthu[i]['PhuThuThucHienTaiNha']+'__5_'+phuthu[i]['id'])
							if((window.loaidoituongkham=="BHYT") && (parseFloat(phuthu[i]["GiaBaoHiem"])>0 )){
								window.thanhtien_vienphi=0;
								window.thanhtien_bhyt=parseInt(phuthu[i]["GiaBaoHiem"])+parseInt(phuthu[i]["GiaPhuThuBenhVien"])+parseInt(phuthu[i]['PhuThuThucHienTaiNha']);
								window.phithuchien=(parseInt(phuthu[i]["Gia"])+parseInt(phuthu[i]['PhuThuThucHienTaiNha']));
								window.bn_chitra=parseInt(window.phithuchien)-parseInt(BHChiTra);
								if(parseInt(phuthu[i]["HoTro"])>0){
									window.bn_chitra=window.phithuchien-parseInt(phuthu[i]["HoTro"]);
								}
							}else{
								window.thanhtien_vienphi=(parseInt(phuthu[i]["Gia"])+parseInt(phuthu[i]['PhuThuThucHienTaiNha']));
								window.thanhtien_bhyt=0;
								window.phithuchien=window.thanhtien_vienphi;
								window.bn_chitra=0;
							}
							$('#rowed5').jqGrid("setCell", rowId, 'PhiThucHien', window.phithuchien);
							$('#rowed5').jqGrid("setCell", rowId, 'BNChiTra', window.bn_chitra);
						}
					}else{
						$('#rowed5').jqGrid("setCell", rowId, 'PhiThucHien', 0);
						}
					}
					tinhtongtien();
 } }]} },
  				{name: 'NhomThucHien', index: 'NhomThucHien', search: false, width: "20%", editable: true, align: 'center', hidden: true,edittype:"select",formatter:'select',editoptions:{value: bophanthuchien}, classes:'colNhomThucHien'},
				{name:'NguoiChiDinh',index:'NguoiChiDinh',width:"12%", align:'left',hidden:false, editable: false,edittype:"select", classes:'nguoichidinh',editoptions:{value:nguoichidinh},formatter: "select"},
				{name:'NguoiChiDinh2',index:'NguoiChiDinh2',width:"12%", align:'left',hidden:true, editable: true,edittype:"select", classes:'nguoichidinh2',editoptions:{value:nguoichidinh},formatter: "select"},
			//	{name: 'GiaThueNgoaiThucHien', index: 'GiaThueNgoaiThucHien', search: false, width: "30%", editable: false, align: 'left', hidden: true},
			{name: 'GiaThueNgoaiThucHien', index: 'GiaThueNgoaiThucHien', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'ThoiGianTrungBinhThucHien', index: 'ThoiGianTrungBinhThucHien', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'IDKham', index: 'IDKham', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'MaBenhNhan', index: 'MaBenhNhan', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'LyDoHuyBo', index: 'LyDoHuyBo', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'Huy', index: 'Huy', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'IDLuotKham', index: 'IDLuotKham', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'Luu', index: 'Luu', search: false, width: "30%", editable: false, align: 'left', hidden: true},
				{name: 'IDNhomCLS', index: 'IDNhomCLS', search: false, width: "10%", editable: false, align: 'left', hidden: true},
				{name: 'NgayGioTao', index: 'NgayGioTao', search: false, width: "10%", editable: false, align: 'left', hidden: true},
				{name: 'LanChiDinh', index: 'LanChiDinh', search: false, width: "10%", editable: false, align: 'left', hidden: true},
				{name: 'XetNghiem', index: 'XetNghiem', search: false, width: "10%", editable: false, align: 'left', hidden: true},
				{name: 'PhanTramCungChiTra', index: 'PhanTramCungChiTra', search: false, width: "10%", editable: false, align: 'left', hidden: true},
				{name: 'ThanhTienCungChiTra', index: 'ThanhTienCungChiTra', search: false, width: "10%", editable: false, align: 'left', hidden: true},
				{name: 'Color', index: 'Color', search: false, width: "20%", editable: false, align: 'left', hidden: true},
				{name: 'Sua', index: 'Sua', search: false, width: "20%", editable: false, align: 'left', hidden: true},
				{name: 'IDBacSyCD', index: 'IDBacSyCD', search: false, width: "20%", editable: false, align: 'left', hidden: true},
				{name: 'Code', index: 'Code', search: false, width: "5%", editable: true, align: 'left', hidden: true,editoptions:{dataEvents: [{ type: 'change keyup', fn: function(e) {
					var row = $(e.target).closest('tr.jqgrow');
					var rowId = row.attr('id');
					$("#rowed5").jqGrid('setCell',rowId,'Sua', '1');
				}}]}
				},
				{name: 'IsBHYT', index: 'IsBHYT', search: false, width: "10%", editable: false, align: 'left', hidden: true},
				{name: 'TenBHYT', index: 'TenBHYT', search: false, width: "10%", editable: false, align: 'left', hidden: true}
            ],
			loadonce: false,
            scroll: false,
            modal: true,
			rownumbers: false,
            shrinkToFit: true,
			//grid_save_option: "",
          	//  cmTemplate: {sortable: false},
            rowNum: 10000000,
			pginput:false,
			pgbuttons:false,
            rowList: [],
            pager: '#prowed5',
            sortname: 'ThoiGianVaoKham',
            height: 100,
            width: 100,
            viewrecords: false,
            ignoreCase: true,
            sortorder: "desc",
			footerrow:true,
			// moi them
			cellEdit: true,
			afterEditCell: function (rowid, celname, value, iRow, iCol) {	// them cái này nữa
				//alert();
			},
			 onCellSelect: function (rowid,iCol,cellcontent,e) {
				// alert(iCol)
				if(iCol==16){
					$('#rowed5 td.nguoichidinh2').hide();
					$('#rowed5 td.nguoichidinh').show();
					var rowData = $("#rowed5").getRowData(rowid);
					if($("#"+rowid+"_NguoiChiDinh2_combobox").length==0){
						create_combobox_inline_new('NguoiChiDinh2',rowid,'rowed5',create_Dm_bs_grid,window.grid_databs,rowData['IDBacSyCD'],1,bs_callback);

					}
					$('#rowed5 tr#'+rowid+' td.nguoichidinh').hide();
					$('#rowed5 tr#'+rowid+' td.nguoichidinh2').show();
					$('#'+rowid+'_NguoiChiDinh2_combobox').focus();
					$('#'+rowid+'_NguoiChiDinh2_combobox').select();
				}
				if(iCol==17){
					$('#rowed5 tr#'+rowid+' td.nguoichidinh2').hide();
					$('#rowed5 tr#'+rowid+' td.nguoichidinh').show();
				}
			},
			ondblClickRow: function(rowId, rowIndex, columnIndex) {

			},
            loadComplete: function(data) {
				if(window.loadformlandau==0){
					setTimeout(function(){
						$("#rowed4").jqGrid('setGridParam',{datatype: 'json',url:"pages.php?module=<?=$modules?>&view=<?=$view?>&action=data_hangmucloaikham_all&trangthaikham="+window.n_trangthaikham+"&idluotkham="+window.idluotkham+"&phantram="+window.phantram+'&nguoinuocngoai='+window.n_nguoinuocngoai+'&doituong='+window.loaidoituongkham}).trigger('reloadGrid');
					},100);
				}
				window.loadformlandau=1;

				var tmp1 = $("#rowed5").jqGrid('getDataIDs');
				var tt_bhyt =0;
				var tt_vienphi =0;
				var phithuchien =0;
				var x=0;
				if(tmp1.length>0){
					$("#btn_chidinh").button('disable');
					//$("#btn_luu").button('enable');
				}else{
					//$("#btn_luu").button('disable');
				}
				window.chidinhlandau=0;
				$("#btn_luu").button('enable');
				for(var i=0;i < tmp1.length;i++){
					jQuery("#rowed5").jqGrid('editRow',tmp1[i]);
					var rowData = $("#rowed5").getRowData(tmp1[i]);

					xoa = "<input class='custom_button_n' style='height:22px;width:50px; box-shadow:none!important; cursor:pointer;' type='button' value='Xóa' onclick=\"n_xoa('"+tmp1[i]+"');\" />";
					//alert(xoa);
					$("#rowed5").jqGrid('setRowData',tmp1[i],{Xoa:xoa});
					$("#rowed5").jqGrid('setRowData', tmp1[i], false, { background: '#D3D3D3',border:'1px solid #A9A9AA' });
					if(rowData["TrangThai"]=="HuyBo"){
						jQuery("#rowed5").jqGrid('saveRow',tmp1[i]);
						$("#rowed5").jqGrid('setRowData', tmp1[i], false, { background: '#A9A9AA',border:'1px solid #BBBBBB' });
					}else if(window.loaidoituongkham=="BHYT" && rowData['TrangThai']!='HuyBo'){
						if(rowData["Color"]=="1" && rowData["TrangThai"]!='HuyBo'){
							$("#rowed5").jqGrid('setRowData', tmp1[i], false, { background: '#C5F7C1',border:'1px solid #dfd9c3' });
						}else if(rowData["Color"]=="2" && rowData["TrangThai"]!='HuyBo'){
							$("#rowed5").jqGrid('setRowData', tmp1[i], false, { background: '#FDFCC2',border:'1px solid #dfd9c3' });
						}else if(rowData["Color"]=="3" && rowData["TrangThai"]!='HuyBo'){
							$("#rowed5").jqGrid('setRowData', tmp1[i], false, { background: '#DE5145',border:'1px solid #dfd9c3' });
						}
					}
					$("#gview_"+tmp1[i]+"_NguoiChiDinh2_grid").attr('hienthi',0);
				}
				tinhtongtien();
				$('.ui-button-icon-only').removeAttr('title');
				//$('.nguoichidinh').removeAttr('title');
				setTimeout(function(){
					window.loadlandau=1;
				},1500)

            },
            caption: " Hạng mục loại khám được chọn <span id='luotkhamnoingoai'></span>"
        });

       $("#rowed5").jqGrid('navGrid', "#prowed5", {add: false, edit: false, del: false, search: false, refresh: false,prmView: false, closeAfterEdit: true, clearAfterAdd: true, navkeys: [true, 38, 40], closeOnEscape: true});
		$("#rowed5").jqGrid('bindKeys', {});

		if(window.loaidoituongkham=="BHYT"){
			$("#luotkhamnoingoai").html("( Bảo hiểm y tế - Số thẻ: <?=$tam[0]['SoThe']?> ) ");
		}else{
			$("#luotkhamnoingoai").html("( Viện phí )");
		}
		add_namclass();
}
function create_goikham() {
	$("#data_goikham").jqGrid({
		url: 'pages.php?module=<?= $modules ?>&view=<?= $view ?>&action=data_goikham',
		datatype: "json",
		colNames: ['Id gói khám','<?php lang('tengoikham')?>', '<?php lang('tiendkien')?>', '<?php lang('mota')?>', '<?php lang('ghichu')?>'],
		colModel: [
			{name: 'ID_GoiKham', index: 'ID_GoiKham', width: "0%", editable: false, align: 'left', hidden: true},
			{name: 'TenGoiKham',search:true, index: 'TenGoiKham', width: "30%", editable: false, align: 'left', hidden: false},
			{name: 'SoTienDuKien', index: 'SoTienDuKien', width: "15%", editable: false, align: 'right', hidden: false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
			{name: 'MoTa', index: 'MoTa', search: false, width: "15%", editable: false, align: 'left', hidden: false},
			{name: 'GhiChu', index: 'GhiChu', width: "40%", editable: false, align: 'left', hidden: false},
		],
			loadonce: true,
			scroll: 1,
			modal:true,
			pager: '#pdata_goikham',
			rowNum: 1000,
			gridview: true,
			pginput:false,
			pgbuttons:false,
			rowList:[],
			sortname: 'ID_GoiKham',
			height:100,
			width: 100,
			viewrecords: true,
			ignoreCase:true,
			shrinkToFit:true,
			grouping: false,
			stringResult:true,
			sortorder: "asc",
		
		afterShowForm : function (formid) {

		},
		onSelectRow: function(id) {
			if (id !== lastsel) {
				$("#data_goikham").jqGrid('restoreRow', lastsel);
				$(data_goikham).jqGrid('editRow', id, true);
				lastsel = id;
			} else {
				$("#data_goikham").jqGrid('restoreRow', lastsel);
				lastsel = "";
				//alert(id)
			}
			var rowData = jQuery(this).getRowData(id); 
			var ID_GoiKham = rowData['ID_GoiKham'];// alert(ID_LuotKham);				
			$("#data_loaikham").jqGrid('setGridParam',{datatype: 'json',url:"pages.php?module=<?=$modules?>&view=<?=$view?>&action=data_loaikham_by_idgoikham&id="+ID_GoiKham+'&idluotkham='+window.idluotkham}).trigger('reloadGrid');
		},
		ondblClickRow: function(rowId, rowIndex, columnIndex) {
		
		},
		onselect: function(rowId, rowIndex, columnIndex) {
		  
		},
	
		loadComplete: function(data) {
			ids = $('#data_goikham').jqGrid('getDataIDs');				 
			$("#data_goikham").jqGrid("setSelection",ids[0], true);
		},
		caption: "<?php lang('goikham')?>"
	});
$("#data_goikham").jqGrid('navGrid', "#pdata_goikham", {add: false, edit: false, del: false, search: false, refresh: true, closeAfterEdit: true, clearAfterAdd: true, navkeys: [true, 38, 40], closeOnEscape: true});
$("#data_goikham").jqGrid('bindKeys', {});
$("#data_goikham").jqGrid('filterToolbar', {searchOperators: false, searchOnEnter: false, defaultSearch: "cn"});
}
	


function create_loaikham() {
		mydata=[];
	$("#data_loaikham").jqGrid({
		data: mydata,
		datatype: "local",
		colNames: ['Id gói khám','<?php lang('tenlk')?>',  '<?php lang('giavienphi')?>',  '<?php lang('giavienphi')?>','<?php lang('giabhyt')?>','<?php lang('phuthu')?>', '<?php lang('mota')?>',  'GiaThueNgoaiThucHien',  'ThoiGianTrungBinhThucHien',  'IDLuotKham',  'IDPhongChuyenMon',  'MaBenhNhan',  'ID_NhomCLS',  'ID_DMLoaiKham_Phongban','HeSoNuocNgoai','Color','','TenBHYT','HoTro'],
		colModel: [
			{name: 'ID_LoaiKham', index: 'ID_LoaiKham', width: "0%", editable: false, align: 'left', hidden: true},
			{name: 'TenLoaiKham', index: 'TenLoaiKham', search: true, width: "30%", editable: false, align: 'left', hidden: false,cellattr: function (rowId, val, rawObject) {
				    return rawObject[17] === "" ? ' title="Tên BHYT: Không có"' : ' title="Tên BHYT: '+rawObject[17]+'"';
				}},
			{name:'GiaHienThi',index:'GiaHienThi', width:"10%", editable:true,align:'right',edittype:"text",hidden:false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
			{name:'GiaBaoChoBN',index:'GiaBaoChoBN', width:"10%", editable:true,align:'right',edittype:"text",hidden:true,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
			{name:'GiaTheoBaoHiem',index:'GiaTheoBaoHiem', width:"10%", editable:true,align:'right',edittype:"text",hidden:false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
			{name:'GiaPhuThu',index:'GiaPhuThu', width:"10%", editable:true,align:'right',edittype:"text",hidden:false,formatter:'currency',formatoptions:{decimalSeparator:".", thousandsSeparator: ",", decimalPlaces: 0, prefix: "", defaultValue: '0'}},
			{name: 'GhiChu', index: 'GhiChu', search: false, width: "40%", editable: false, align: 'left', hidden: false},
			{name: 'GiaThueNgoaiThucHien', index: 'GiaThueNgoaiThucHien', search: false, width: "30%", editable: false, align: 'left', hidden: true},
			{name: 'ThoiGianTrungBinhThucHien', index: 'ThoiGianTrungBinhThucHien', search: false, width: "30%", editable: false, align: 'left', hidden: true},
			{name: 'IDLuotKham', index: 'IDLuotKham', search: false, width: "30%", editable: false, align: 'left', hidden: true},
			{name: 'IDPhongChuyenMon', index: 'IDPhongChuyenMon', search: false, width: "30%", editable: false, align: 'left', hidden: true},
			{name: 'MaBenhNhan', index: 'MaBenhNhan', search: false, width: "30%", editable: false, align: 'left', hidden: true},
			{name: 'ID_NhomCLS', index: 'ID_NhomCLS', search: false, width: "30%", editable: false, align: 'left', hidden: true},
			{name: 'ID_DMLoaiKham_Phongban', index: 'ID_DMLoaiKham_Phongban', search: false, width: "10%", editable: false, align: 'left', hidden: true},
			{name: 'HeSoNuocNgoai', index: 'HeSoNuocNgoai', search: false, width: "10%", editable: false, align: 'left', hidden: true},
			{name: 'Color', index: 'Color', search: false, width: "30%", editable: false, align: 'left', hidden: true},
			{name: 'PhanTramCungChiTra', index: 'PhanTramCungChiTra', search: false, width: "30%", editable: false, align: 'left', hidden: true},
			{name: 'TenBHYT', index: 'TenBHYT', search: false, width: "30%", editable: false, align: 'left', hidden: true},
			{name: 'HoTro', index: 'HoTro', search: false, width: "30%", editable: false, align: 'left', hidden: true},
		],
	   loadonce: false,
		scroll: 1,
		modal: true,
		rowNum: 1000,
		multiselect: true,
		rowList: [30, 50, 70],
		pager: '#pdata_goikham',
		height: 100,
		width: 100,
		viewrecords: true,
		ignoreCase: true,
		shrinkToFit: true,
		grid_save_option: "",
		cmTemplate: {
		sortable: false
		},
		afterShowForm : function (formid) {

		},
		onSelectRow: function(id) {
			if (id !== lastsel) {
				$("#data_goikham").jqGrid('restoreRow', lastsel);
				$(data_goikham).jqGrid('editRow', id, true);
				lastsel = id;
			} else {
				$("#data_goikham").jqGrid('restoreRow', lastsel);
				lastsel = "";
			}
		},
		ondblClickRow: function(rowId, rowIndex, columnIndex) {
		
		},
		onselect: function(rowId, rowIndex, columnIndex) {
		  
		},
	
		loadComplete: function(data) {
			grid_filter_enter("#data_loaikham");
			var tmp1 = $("#data_loaikham").jqGrid('getDataIDs'); 
			for(var i=0;i < tmp1.length;i++){ 
				var rowData = $("#data_loaikham").getRowData(tmp1[i]);	
				if(window.loaidoituongkham=="BHYT"){
					if(rowData["Color"]=="1"){
						$("#data_loaikham").jqGrid('setRowData', tmp1[i], false, { background: '#C5F7C1',border:'1px solid #dfd9c3' });
					}else if(rowData["Color"]=="2"){
						$("#data_loaikham").jqGrid('setRowData', tmp1[i], false, { background: '#FDFCC2',border:'1px solid #dfd9c3' });
					}else if(rowData["Color"]=="3" && rowData["TrangThai"]!='HuyBo'){
						$("#data_loaikham").jqGrid('setRowData', tmp1[i], false, { background: '#DE5145',border:'1px solid #dfd9c3' });
					}
				}
			}
		},
		caption: "<?php lang('loaikham')?>"
	});
	$("#data_goikham").jqGrid('navGrid', "#pdata_goikham", {add: false, edit: false, del: false, search: false, refresh: true, closeAfterEdit: true, clearAfterAdd: true, navkeys: [true, 38, 40], closeOnEscape: true});
$("#data_loaikham").jqGrid('bindKeys', {});

$("#data_loaikham").jqGrid('filterToolbar', {searchOperators: false, searchOnEnter: false, defaultSearch: "cn"});
}

function create_layout() {
	$('#panel_main').layout({
		resizerClass: 'ui-state-default'
				, east: {
			resizable: true
					, size: "58%"
					, spacing_closed: 27
					, togglerLength_closed: 85
					, togglerAlign_closed: "center"
					, togglerContent_closed: "<div id='menu_toggle'>X<BR>O<BR>N<BR>G</div>"
					, togglerTip_closed: "Open & Pin Menu"
					, sliderTip: "Slide Open Menu"
					, slideTrigger_open: "mouseover"
					, fxSettings_close: {easing: "easeOutQuint"}
			, onresize_end: function() {
				resize_control();

			}
			, onopen_end: function() {


			}
			, onclose_end: function() {


			}

		}
		, center: {
			resizable: true
					, size: "32%"

					, fxName: "drop"		// none, slide, drop, scale
					, fxSpeed_open: 450
					, fxSpeed_close: 450
					, fxSettings_open: {easing: "easeInQuint"}
			, fxSettings_close: {easing: "easeOutQuint"}

			, onresize_end: function() {
				resize_control();
			}
			, onopen_end: function() {


			}
			, onclose_end: function() {

			}
		}
		 , west:  {
			resizable: true
					, size: "10%"
					, spacing_closed: 27
					, togglerLength_closed: 85
					, togglerAlign_closed: "center"
					, togglerContent_closed: "<div id='menu_toggle'>X<BR>O<BR>N<BR>G</div>"
					, togglerTip_closed: "Open & Pin Menu"
					, sliderTip: "Slide Open Menu"
					, slideTrigger_open: "mouseover"
					, fxSettings_close: {easing: "easeOutQuint"}
			, onresize_end: function() {
				resize_control();

			}
			, onopen_end: function() {


			}
			, onclose_end: function() {


			}

		}
	});
}
	

function n_xoa(tam){
	$.post('pages.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_thanhtoan&idluotkham=<?=$_GET['idluotkham']?>').done(function(data){
		var datacheck=$.trim(data);
		if((datacheck=='0' && window.n_khoachidinh!=1) || window.chophepluu==1){
	//if(window.n_dathanhtoanbill!=1 && window.n_khoachidinh!=1){
		//if(window.n_dathanhtoanbill!=1 && window.n_idtrangthai!='KetThucKham'){
			var rowData_luu = $("#rowed5").getRowData(tam);
			if(rowData_luu["Luu"]!=1){
				$('#rowed5').jqGrid('delRowData',tam);
				var tmp5 = $("#rowed5").jqGrid('getDataIDs'); 
				var tt_bhyt =0;
				var tt_vienphi =0;
				var phithuchien =0;
				for(var i=0;i < tmp5.length;i++){ 
					var rowData = $("#rowed5").getRowData(tmp5[i]);
					xoa = "<input class=' custom_button_n' style='height:22px;width:50px; box-shadow:none!important; cursor:pointer;' type='button' value='Xóa' onclick=\"n_xoa('"+tmp5[i]+"');\" />"; 
					$("#rowed5").jqGrid('setRowData',tmp5[i],{Xoa:xoa});	
					 tt_vienphi =parseFloat(tt_vienphi) + parseFloat(rowData["ThanhTienVienPhi"]);
					 tt_bhyt =parseFloat(tt_bhyt) + parseFloat(rowData["ThanhTienBHYT"]);
					 phithuchien =parseFloat(phithuchien) + parseFloat(rowData["PhiThucHien"]);
				}
				$("#thanhtienvienphi").val(formatMoney(tt_vienphi));
				$("#thanhtienbhyt").val(formatMoney(tt_bhyt));
				$("#phithuchien").val(formatMoney(phithuchien));
				
				tinhtongtien();
			}else{
				$.post('pages.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_xoa&id_kham='+tam).done(function(data) {
					var rs=data.split(';;');
					//alert(rs[0]);
					if(rs[0]=='true' || window.chophepluu==1){
						$("#idk").val(tam);
						$('#dialog').dialog('open');
					}else if(rs[1]=='bschinh'){
						$('#dialog_bschinh').dialog('open');
					}else{
						tooltip_message("Loại khám này không được phép xóa");
					}		 
				});
			}
		}else{
			alert_khoa(datacheck);
		}
	});
}
	
function load_select_hotennv(){
	window.hotennv = $.ajax({url: "pages.php?module=web_services&function=get_auto_edit_option_byid&action=index&term=ID_PhongBan<>21&status=2&tables=DM_NhanVien&id=ID_NhanVien&name=NickName", async: false, success: function(data, result) {if (!result) alert('Không load được danh mục nhân viên');}}).responseText;	
}
function load_select_bophanthuchien(){ 
	window.bophanthuchien = $.ajax({url: "pages.php?module=<?= $modules ?>&view=<?= $view ?>&action=data_phongban", async: false, success: function(data, result) {if (!result) alert('Không load được danh mục phòng ban');}}).responseText;
}
function load_select_trangthai(){
	window.trangthai = $.ajax({url: "pages.php?module=web_services&function=get_auto_edit_option&action=index&term=&status=2&tables=DM_TrangThaiCLSCuaBenhNhan&id=ID4Dev&name=TenTrangThaiCLSCuaBenhNhan", async: false, success: function(data, result) {if (!result) alert('Không load được danh mục trạng thái');}}).responseText;	
}
function load_select_nguoichidinh(){
	window.nguoichidinh = $.ajax({url: 'pages.php?module=web_services&function=get_auto_edit_option&action=index&term=&status=2&tables=DM_NhanVien&id=ID_NhanVien&name=NickName', async: false, success: function(data, result) {if (!result) alert('Không load được danh mục nhân viên');}}).responseText;
	$("#rowed5").setColProp('#NguoiChiDinh', { editoptions: { value: nguoichidinh} });
	$('#NguoiChiDinh').empty();
	create_select("#NguoiChiDinh",nguoichidinh);
}
function load_select_tennhomcha(){
	window.tennhomcha = $.ajax({url: "pages.php?module=web_services&function=get_auto_edit_option&action=index&term=&status=2&tables=NhomCLS&id=ID_NhomCLS&name=TenNhom", async: false, success: function(data, result) {if (!result) alert('Không load được danh mục NhomCLS');}}).responseText;	
}
function formatMoney(num) {
    var p = num.toFixed(2).split(".");
    return p[0].split("").reverse().reduce(function(acc, num, i, orig) {
        return  num + (i && !(i % 3) ? "," : "") + acc;
    }, "");
}

function inchidinh(){
	if(window.n_incd==1){
		$.cookie("in_status", "print_direct");
		$('#btn_in').button('enable');
	}else{
		$.cookie("in_status", "print_preview");
		$('#btn_xemin').button('enable');
	}
	var tmp1 = $("#rowed5").jqGrid('getDataIDs');
	var _xn=0;
	for(var i=0;i<tmp1.length;i++){
		 var rowData = $("#rowed5").getRowData(tmp1[i]);
		 if(rowData['XetNghiem']==1 && rowData['TrangThai']!='HuyBo'){
			_xn=1;
		 }
		if(i==tmp1.length-1){
			dialog_report("Xem trước khi in",90,90,"u78787878975f","pages.php?module=report&view=<?=$modules?>&action=phieuchidinhkham_all&ac="+window.n_incd+"&header=top&id_benhnhan="+window.idbenhnhan+"&id_luotkham="+window.idluotkham+"&xetnghiem="+_xn+"&type=report&id_form=10",'PhieuChiDinh');
			$(".modalu78787878975f").dialog("close");
		}
	}
	window.n_incd=0;
}
function add_namclass(){
	$("#rowed4").hover(function(){
		$(this).find("tr").addClass('nam-hover');
	});
	$("#rowed5").hover(function(){
		$(this).find("tr").addClass('nam-hover');
	});
}

function tinhtongtien(){
	var  Sum_ThanhTienVienPhi = $("#rowed5").jqGrid('getCol', 'ThanhTienVienPhi', false, 'sum');
	var  Sum_ThanhTienBHYT = $("#rowed5").jqGrid('getCol', 'ThanhTienBHYT', false, 'sum');
	var  Sum_BNChiTra = $("#rowed5").jqGrid('getCol', 'BNChiTra', false, 'sum');
	var  Sum_PhiThucHien = $("#rowed5").jqGrid('getCol', 'PhiThucHien', false, 'sum');
	var  Sum_HoTro = $("#rowed5").jqGrid('getCol', 'HoTro', false, 'sum');
	$("#rowed5").jqGrid('footerData','set', {
		LoaiKham: 'Tổng tiền:',
		ThanhTienVienPhi: Sum_ThanhTienVienPhi,
		ThanhTienBHYT: Sum_ThanhTienBHYT,
		BNChiTra: Sum_BNChiTra,
		PhiThucHien: Sum_PhiThucHien,
		HoTro:Sum_HoTro,
	});
}

function alert_khoa(input){
	if(input==1){
		tooltip_message("Lượt khám này đã hoàn tất ra viện");
		$("#thongbao").html("Thông báo: Lượt khám này đã hoàn tất ra viện");
	}else if(input==2){
		tooltip_message("Lượt khám này đã khóa BHYT");
		$("#thongbao").html("Thông báo: Lượt khám này đã khóa BHYT");
	}else if(input==3){
		tooltip_message("Lượt khám này đã khóa BHCC");
		$("#thongbao").html("Thông báo: Lượt khám này đã khóa BHCC");
	}else if(input==4){
		tooltip_message("Lượt khám này đã thanh toán");
		$("#thongbao").html("Thông báo: Lượt khám này đã thanh toán");
	}else if(input==5){
		tooltip_message("Lượt khám này là lượt khám nội trú");
		$("#thongbao").html("Thông báo: Lượt khám này là lượt khám nội trú");
	}
}

function create_Dm_bs_grid(elem,datalocal){
		datalocal=jQuery.parseJSON(datalocal);
		$(elem).jqGrid({
		datastr:datalocal,
		datatype: "jsonstring" ,
		colNames:['NickName', 'Họ tên'],
		colModel:[
			{name:'NickName',index:'NickName', search: true,width:"30%"},
			{name:'HoTen',index:'HoTen', search: true,width:"70%", searchoptions: { sopt: ['cn'] }},
		],
		hidegrid: false,
		gridview: true,
		loadonce: false,
		scrollrows : true,
		scroll: false,
		modal:true,
		rowNum: 1000,
		rowList:[],
		pager: '#prowed_dm_bs',
		sortname: 'NickName',
		height:150,
		width: 400,
		viewrecords: true,
		ignoreCase:true,
		shrinkToFit:true,
		cmTemplate: {sortable:false},
		sortorder: "desc",
		serializeRowData: function (postdata) {
		},
		onSelectRow: function(id){
			if(window.loadlandau==1){
				var rs=elem.split('_');
				var id_new=rs[0].split('#');
				$("#rowed5").jqGrid('setCell',id_new[1],'Sua', '1');
				$("#rowed5").jqGrid('setCell',id_new[1],'NguoiChiDinh', id);
				//alert(gview_1547890_NguoiChiDinh2_grid);
				setTimeout(function(){
					if($("#gview_"+id_new[1]+"_NguoiChiDinh2_grid").is(":visible")===false && $("#gview_"+id_new[1]+"_NguoiChiDinh2_grid").attr('hienthi')==1){
						$('#rowed5 td.nguoichidinh2').hide();
						$('#rowed5 td.nguoichidinh').show();
					}
				},100);
			}
		},
		ondblClickRow: function (id, rowIndex, columnIndex) {

 		},
		loadComplete: function(data) {
			//$("#donthuoc_rowed3").jqGrid('getGridParam', 'selrow')
		},
	});
	 $(elem).jqGrid('filterToolbar',{searchOperators : false,searchOnEnter:false,defaultSearch:"cn"});
	 $(elem).jqGrid('bindKeys', {} );
}
function bs_callback(){
	$('#rowed5 td.nguoichidinh2').hide();
	$('#rowed5 td.nguoichidinh').show();
}
function create_nguoicd(elem, datalocal) {
	datalocal = jQuery.parseJSON(datalocal);
	$(elem).jqGrid({
		datastr: datalocal,
		datatype: "jsonstring",
		colNames: ['NickName', 'Họ tên'],
		colModel: [
			{name: 'NickName', index: 'NickName', hidden: false,width:1},
			{name: 'HoTen', index: 'HoTen', hidden: false,width:5},
		],
		hidegrid: false,
		gridview: true,
		loadonce: true,
		scroll: 1,
		modal: true,
		rowNum: 100,
		rowList: [],
		height: 100,
		width: 300,
		viewrecords: true,
		ignoreCase: true,
		shrinkToFit: true,
		cmTemplate: {sortable: false},
		sortorder: "desc",
		serializeRowData: function(postdata) {
		},
		onSelectRow: function(id) {

/*		  var rowData = $(this).getRowData(id);
		  //alert(rowData);
		  $("#chuyenden2").val(rowData["tenbenhvien"]);
*/
		},
	});
	$(elem).jqGrid('filterToolbar', {searchOperators: false, searchOnEnter: false, defaultSearch: "cn"});
	$(elem).jqGrid('bindKeys', {});
}

function create_combobox_inline_new(input,rowId,grid_,fun,data,defaultvalue,isfocus,callback){
	var grid   = rowId+'_'+input+'_grid';
	var input1 = rowId+'_'+input+'_combobox';
	var dialog = rowId+'_'+input+'_dialog';
	var grid1      ="id='"+grid+"'";
	var dialog1    ="id='"+dialog+"'";
	var input_tam='#'+rowId+'_'+input;
	var input_tam1='#'+rowId+'_'+input+'_combobox';
	$("body").append("<div  "+dialog1+"><table "+grid1+"></table></div>");
	$( '#'+dialog ).css({
		"position":"absolute",
		"z-index":"1000000",
		"display":"none",
		"box-shadow":"0px 0px 6px #333"
	});
	$("#"+grid_).jqGrid('unbindKeys');
	var with_idthuoc=parseFloat($('#jqgh_'+grid_+'_'+input).width())-32;
	$(input_tam).hide();
	$('#'+grid_+' '+input_tam).before( '<input id="'+input1+'" class="editable" type="text" style="width:'+with_idthuoc+'px" role="textbox">' );
	if(typeof window.id_combox_dialog == 'undefined'){
		window.id_combox_dialog= new Array();
	}
	window.id_combox_dialog.push(dialog);
	$(grid).click(function(){
		  $(grid).data('clicked', true);
	});
	$("#"+grid_).jqGrid('unbindKeys');
	callback(input1);
	fun('#'+grid,data);
	init_combox(input_tam1,input_tam,'#'+dialog,'#'+grid,defaultvalue,'bw');
	afterInit_combox(input_tam1,'#'+dialog,'#'+grid,input_tam);	
	if(isfocus==1){	
		setTimeout(function(){
			$('#'+rowId+'_'+input+'_combobox').focus();
			$('#'+rowId+'_'+input+'_combobox').select();
			$("#gview_"+rowId+"_NguoiChiDinh2_grid").attr('hienthi',1);
		},500);
	}
}

function resize_control() {
	$("#rowed3 ").setGridWidth($(".left_col").width() - 11);
	$("#rowed3").setGridHeight($(".right_col").height() - 58);
	$("#rowed4").setGridWidth($(".center_col").width() - 11);
	$("#rowed4").setGridHeight($(".center_col").height() - 93);
	$("#rowed5").setGridWidth($(".right_col").width() - 11);
	$("#rowed5").setGridHeight($(".right_col").height() - 130);
	$("#data_goikham ").setGridWidth($(".data_chongoikham").width() - 300);
	$("#data_goikham").setGridHeight($(".data_chongoikham").height() - 265);
	$("#data_loaikham ").setGridWidth($(".data_chongoikham").width() - 300);
	$("#data_loaikham").setGridHeight($(".data_chongoikham").height() - 240);
}

function saveData(incd,hienNotes){
	if(window.chidinhlandau==0){
		//alert(incd+'_'+hienNotes)
		if(window.n_khoachidinh==1){
			if(hienNotes==1){
				alert("Lượt khám này đã qua ngày");
			}
			if(incd==1){
				setTimeout(function(){
				 inchidinh();
				},1000);
			}
			window.chidinhlandau=0;
		}else{
			$("#rowed5 tbody").addClass('bongmo');
			$("#n_dangluu" ).show();
			$("#btn_luu").button('disable');
			var ids = $('#rowed5').jqGrid('getDataIDs');
			var phancach = "";
			var dataToSend='[';
			for(var i=0;i<=ids.length-1;i++){
				//console.log(i)
				dataToSend += phancach+'{';
				var rowData = $('#rowed5').jqGrid ('getRowData', ids[i]);
				if(rowData['TrangThai']!="HuyBo"){
					var _thuchien=$("#"+ids[i]+"_ThucHien").val();
					var code=$("#"+ids[i]+"_Code").val();
				}else{
					var _thuchien=0;
					var code=rowData['Code'];
				}
				dataToSend += '"IDLuotKham":' + JSON.stringify(rowData['IDLuotKham'])+',';
				dataToSend += '"IDKham":' + JSON.stringify(rowData['IDKham'])+',';
				dataToSend += '"IDLoaiKham":' + JSON.stringify(rowData['IDLoaiKham'])+',';
				dataToSend += '"NhomThucHien":' + JSON.stringify(rowData['NhomThucHien'])+',';
				dataToSend += '"NguoiChiDinh":' + JSON.stringify(rowData['NguoiChiDinh'])+',';
				dataToSend += '"TrangThai":' + JSON.stringify(rowData['TrangThai'])+',';
				dataToSend += '"PhiThucHien":' + JSON.stringify(rowData['PhiThucHien'])+',';
				dataToSend += '"ThanhTienVienPhi":' + JSON.stringify(rowData['ThanhTienVienPhi'])+',';
				dataToSend += '"MaBenhNhan":' + JSON.stringify(rowData['MaBenhNhan'])+',';
				dataToSend += '"ThucHien":' + JSON.stringify(_thuchien)+',';
				dataToSend += '"GiaThueNgoaiThucHien":' + JSON.stringify(rowData['GiaThueNgoaiThucHien'])+',';
				dataToSend += '"ThoiGianTrungBinhThucHien":' + JSON.stringify(rowData['ThoiGianTrungBinhThucHien'])+',';
				dataToSend += '"PhuThu":' + JSON.stringify(rowData['PhuThu'])+',';
				dataToSend += '"BHChiTra":' + JSON.stringify(rowData['BHChiTra'])+',';
				dataToSend += '"DonGiaBHYT":' + JSON.stringify(rowData['DonGiaBHYT'])+',';
				dataToSend += '"PhanTramCungChiTra":' + JSON.stringify(rowData['PhanTramCungChiTra'])+',';
				dataToSend += '"ThanhTienCungChiTra":' + JSON.stringify(rowData['ThanhTienCungChiTra'])+',';
				dataToSend += '"ThanhTienBHYT":' + JSON.stringify(rowData['ThanhTienBHYT'])+',';
				dataToSend += '"Luu":' + JSON.stringify(rowData['Luu'])+',';
				dataToSend += '"Sua":' + JSON.stringify(rowData['Sua'])+',';
				dataToSend += '"Huy":' + JSON.stringify(rowData['Huy'])+',';
				dataToSend += '"LanChiDinh":' + JSON.stringify(rowData['LanChiDinh'])+',';
				dataToSend += '"Code":' + JSON.stringify(code)+',';
				dataToSend += '"IsBHYT":' + JSON.stringify(rowData['IsBHYT'])+',';
				dataToSend += '"LyDoHuyBo":' + JSON.stringify(rowData['LyDoHuyBo']);
				dataToSend += '}';
				phancach=',';
				if(parseInt(rowData['Luu'])!=1){
					$("#rowed5").jqGrid('setCell',ids[i],'Luu', '9');
				}
			}
			dataToSend+=']';
			postData='{"id":'+dataToSend+'}';
			postData=$.parseJSON(postData);
			$.ajax({
				type: 'POST',
				async : false,
				url: 'pages.php?module=<?= $modules ?>&view=<?= $view ?>&action=controller&oper=add&hienmaloi=0&phantram='+window.phantram+'&idluotkham='+window.idluotkham,
				data: postData,
				success: function(data, status, xhr) {
					//window.chidinhlandau=0;
					data=$.parseJSON(data);
					//alert(data.IsLock);
					$("#rowed5 tbody").removeClass('bongmo');
					$("#n_dangluu" ).hide();
					setTimeout(function(){
						$("#btn_luu").button('enable');
					},1000);
					if(data.IsLock==0){
							$("#btn_cddatra").prop( "checked", true );
							$("#rowed5").jqGrid('setGridParam',{datatype: 'json',url:"pages.php?module=<?=$modules?>&view=<?=$view?>&action=data_khamby_idluotkham&id="+window.idluotkham}).trigger('reloadGrid');
							tooltip_message(data.Notes);
							if(incd==1){
								setTimeout(function(){
								 inchidinh();
								},1000);
							}
					}else{
						window.chidinhlandau=0;
						if(hienNotes==1){
							alert(data.Notes);
						}
						if(incd==1){
							setTimeout(function(){
							 inchidinh();
							},1000);
						}
					}
				},
			});
		}
	}
}




function ChuyenCD(GiaBHYT,PhanTramCungChiTra,GiaHienThi,HoTro,ID_LoaiKham,TenLoaiKham,GiaBaoChoBN,GiaPhuThu,GiaThueNgoaiThucHien,IDPhongChuyenMon,MaBenhNhan,ID_NhomCLS,NhomThucHien,ThoiGianTrungBinhThucHien,Color,TenBHYT,NhomBHYT){
	//console.log('Chuyen New');
	$.post('pages.php?module=<?= $modules ?>&view=<?= $view ?>&action=check_thanhtoan&idluotkham=<?=$_GET['idluotkham']?>').done(function(data){
		var datacheck=$.trim(data);
		if(datacheck=='0' && window.n_khoachidinh!=1){
			var tmp1 = $("#rowed5").jqGrid('getDataIDs');
			var tam,ln=0;
			var dem=tmp1+1;
			if((window.loaidoituongkham=="BHYT") && (GiaBHYT>0 )  && window.aduto_tick_bhyt==1){
				var n_phantram =PhanTramCungChiTra;
				window.phantrammoi_new=n_phantram.split('.');
				window.phantram_luu=window.phantrammoi_new[0];
				if(window.phantrammoi_new[1]>0){
					window.phantrammoi=	PhanTramCungChiTra;
				}else{
					window.phantrammoi=window.phantrammoi_new[0];
				}
				if(window.n_trangthaikham==3){
					if(window.phantrammoi==100){
						var thanhtien_vienphi=GiaHienThi;
						var thanhtien_bhyt=parseFloat(GiaBHYT);
						var phi_thuchien=GiaHienThi;
						var bn_chitra=GiaHienThi;
						var bnchitrabh=GiaBHYT;
						window.phantrammoi=100;
						window.phantram_luu=100;
						var isbhyt=0;
					}else{
						var thanhtien_vienphi=GiaHienThi;
						var thanhtien_bhyt=parseFloat(GiaBHYT);
						var phi_thuchien=GiaHienThi;
						var bnchitrabh=((parseFloat(GiaBHYT)*window.phantrammoi)/100);
						var bh_chitra=(GiaBHYT)-bnchitrabh;
						var bn_chitra=(parseFloat(GiaHienThi)-bh_chitra);
						var isbhyt=1;
					}
				}else{
					var thanhtien_vienphi=GiaHienThi;
					var thanhtien_bhyt=parseFloat(GiaBHYT);
					var phi_thuchien=GiaHienThi;
					var bnchitrabh=((parseFloat(GiaBHYT)*window.phantram)/100);
					//alert(bnchitrabh);
					var bh_chitra=parseFloat(GiaBHYT)-bnchitrabh;
					var bn_chitra=(parseFloat(GiaHienThi)-bh_chitra);
					window.phantrammoi=window.phantram;
					var isbhyt=1;
				}
			}else{
				var thanhtien_vienphi=GiaHienThi;
				var thanhtien_bhyt=parseFloat(GiaBHYT);
				var phi_thuchien=GiaHienThi;
				var bn_chitra=GiaHienThi;
				var bnchitrabh=GiaBHYT;
				window.phantrammoi=100;
				window.phantram_luu=100;
				var isbhyt=0;
			}
				if(parseInt(HoTro)>0  && window.aduto_tick_bhyt==1){
					bn_chitra=bn_chitra-parseInt(HoTro);
					var hotro=parseInt(HoTro);
				}else{
					var hotro=0;
				}
				parameters =
						{
							initdata : {IDLoaiKham:ID_LoaiKham,Xoa:"Xóa",LoaiKham:TenLoaiKham,DonGiaVienPhi:GiaBaoChoBN,DonGiaBHYT:GiaBHYT,PhuThu:GiaPhuThu,ThanhTienVienPhi:thanhtien_vienphi, ThanhTienBHYT:bh_chitra,PhiThucHien:phi_thuchien,TrangThai:"DangCho",ThucHien: "0",NguoiChiDinh:"<?=$_SESSION["user"]["id_user"] ?>",NguoiChiDinh2:"<?=$_SESSION["user"]["id_user"] ?>",GiaThueNgoaiThucHien:GiaThueNgoaiThucHien,ThoiGianTrungBinhThucHien:ThoiGianTrungBinhThucHien,IDLuotKham:window.idluotkham,IDPhongChuyenMon:IDPhongChuyenMon,MaBenhNhan:MaBenhNhan,IDNhomCLS:ID_NhomCLS,NhomThucHien:NhomThucHien,BHChiTra:bh_chitra,BNChiTra:bn_chitra,PhanTramCungChiTra:window.phantram_luu,ThanhTienCungChiTra:bnchitrabh,Color:Color,HoTro:hotro,IsBHYT:isbhyt,TenBHYT:TenBHYT,Luu:0},
							position :"last",
							useDefValues : false,
							useFormatter : false,
							addRowParams : {
									keys:true,
									aftersavefunc: function(rowId, response,lastsel) {
										destroy_combobox_inline_new('NguoiChiDinh2',rowId,'rowed5');
										$('#rowed5').focus();
										var current_rowed5=$('#rowed5').jqGrid('getCell',rowId, 'NguoiChiDinh2')
										$('#'+rowId).removeClass("ui-state-highlight").attr({"aria-selected":"false", "tabindex" : "-1"})
										$("#" + rowId).attr("id",current_rowed5);
										$('#'+current_rowed5).removeClass("ui-state-highlight");
										setTimeout(function(){
										   $("#prowed5 .ui-icon-plus").click();
										   var ids = jQuery("#rowed5").jqGrid('getDataIDs');
										   $('#'+ids[ids.length-1]+'_NguoiChiDinh21').focus();
										},200);
									},
									oneditfunc: function(rowId) {
										create_combobox_inline_new('NguoiChiDinh2',rowId,'rowed5',create_Dm_bs_grid,window.grid_databs,<?=$_SESSION['user']['id_user']?>,1,bs_callback)//new
										//inline_enter(rowId);
									},
									afterrestorefunc: function(rowId) {
										destroy_combobox_inline_new('NguoiChiDinh2',rowId,'rowed5');
										$("#rowed5").jqGrid('bindKeys');
										$('#rowed5').focus();
									}
							}//addRowParams
						}
				var tmp2 = $("#rowed5").jqGrid('getDataIDs');
				var dem=0;
				var tontai=0;
				if(tmp2.length==0)
					dem=1;
				for(var i=0;i < tmp2.length;i++){
					var rowData2 = $("#rowed5").getRowData(tmp2[i]);
					if(parseInt(ID_LoaiKham)===parseInt(rowData2["IDLoaiKham"])){
						tontai=1;
					}else{
						if(tontai==0){
							dem=1;
						}
					}
				} //end for 169694
				if(tontai==1){
					var strconfirm = confirm("Loại khám: "+TenLoaiKham+" đã tồn tại, bạn có muốn chỉ định thêm không?");
					if (strconfirm == true){
						dem=1;
					}else{
						dem=0;
						//$("#"+_val).focus();
					}
				}
				if(dem==1){
					if(ID_LoaiKham==3918)
						alert("Để có đủ thông tin làm FRAMINGHAM, vui lòng chỉ định thêm hạng \n mục ĐO ĐIỆN TIM và các xét nghiệm có liên quan!");
					if(NhomBHYT==8 && window.loaidoituongkham=="BHYT" && window.n_maloaidt=="GD_TESTTHOIMA" && window.n_songaythe<150){
						var strconfirm_gd = confirm("Lưu ý: Loại khám này Bảo hiểm không chi trả vì thời gian cấp của thẻ này chưa được 150 ngày!","Thông báo");
						if(strconfirm_gd == true){
							var thanhtien_vienphi=GiaHienThi;
							var thanhtien_bhyt=parseFloat(GiaBHYT);
							var phi_thuchien=GiaHienThi;
							var bn_chitra=GiaHienThi;
							var bnchitrabh=0;
							var bh_chitra=0;
							window.phantrammoi2=100;
							window.phantram_luu2=100;
							var isbhyt=0;
							if(parseInt(HoTro)>0){
								bn_chitra=bn_chitra-parseInt(HoTro);
							}
							parameters2 =
							{
								initdata : {IDLoaiKham:ID_LoaiKham,Xoa:"Xóa",LoaiKham:TenLoaiKham,DonGiaVienPhi:GiaBaoChoBN,DonGiaBHYT:GiaBHYT,PhuThu:GiaPhuThu,ThanhTienVienPhi:thanhtien_vienphi, ThanhTienBHYT:bh_chitra,PhiThucHien:phi_thuchien,TrangThai:"DangCho",ThucHien: "0",NguoiChiDinh:"<?=$_SESSION["user"]["id_user"] ?>",NguoiChiDinh2:"<?=$_SESSION["user"]["id_user"] ?>",GiaThueNgoaiThucHien:GiaThueNgoaiThucHien,ThoiGianTrungBinhThucHien:ThoiGianTrungBinhThucHien,IDLuotKham:window.idluotkham,IDPhongChuyenMon:IDPhongChuyenMon,MaBenhNhan:MaBenhNhan,IDNhomCLS:ID_NhomCLS,NhomThucHien:NhomThucHien,BHChiTra:bh_chitra,BNChiTra:bn_chitra,PhanTramCungChiTra:window.phantram_luu2,ThanhTienCungChiTra:bnchitrabh,Color:Color,HoTro:HoTro,Luu:0},
								position :"last",
								useDefValues : false,
								useFormatter : false,
								addRowParams :{
									keys:true,
									aftersavefunc: function(rowId, response,lastsel) {
										destroy_combobox_inline_new('NguoiChiDinh2',rowId,'rowed5');
										$('#rowed5').focus();
										var current_rowed5=$('#rowed5').jqGrid('getCell',rowId, 'NguoiChiDinh2')

										$('#'+rowId).removeClass("ui-state-highlight").attr({"aria-selected":"false", "tabindex" : "-1"})
										$("#" + rowId).attr("id",current_rowed5);
										$('#'+current_rowed5).removeClass("ui-state-highlight");
										setTimeout(function(){
										   $("#prowed5 .ui-icon-plus").click();
										   var ids = jQuery("#rowed5").jqGrid('getDataIDs');
										   $('#'+ids[ids.length-1]+'_NguoiChiDinh21').focus();
										},200);

									},
									oneditfunc: function(rowId) {
										create_combobox_inline_new('NguoiChiDinh2',rowId,'rowed5',create_Dm_bs_grid,window.grid_databs,<?=$_SESSION['user']['id_user']?>,1,bs_callback)//new
									},
									afterrestorefunc: function(rowId) {
										destroy_combobox_inline_new('NguoiChiDinh2',rowId,'rowed5');
										$("#rowed5").jqGrid('bindKeys');
										$('#rowed5').focus();
									}
								}//addRowParams
							}
							jQuery("#rowed5").jqGrid('addRow',parameters2);
						}else{
							// nguoc lai

						}
					}else{
						jQuery("#rowed5").jqGrid('addRow',parameters);
					}
					$("#gs_TenLoaiKham").focus();
					$("#gs_TenLoaiKham").select();
				}
				var tt_bhyt =0;
				var tt_vienphi =0;
				var phithuchien =0;
				var y=0;
				var x=0;
				var tmp3= $("#rowed5").jqGrid('getDataIDs');
				for(var i=0;i < tmp3.length;i++){
					var rowData3 = $("#rowed5").getRowData(tmp3[i]);
					xoa = "<input class=' custom_button_n' style='height:22px;width:50px; box-shadow:none!important; cursor:pointer;' type='button' value='Xóa' onclick=\"n_xoa('"+tmp3[i]+"');\" />";
					$("#rowed5").jqGrid('setRowData',tmp3[i],{Xoa:xoa});
					//console.log(rowData3["Color"]);
					if(window.loaidoituongkham=="BHYT" && rowData3['TrangThai']!='HuyBo'){
						if(rowData3["Color"]=="1" && rowData3["TrangThai"]!='HuyBo'){
							$("#rowed5").jqGrid('setRowData', tmp3[i], false, { background: '#C5F7C1',border:'1px solid #dfd9c3' });
						}else if(rowData3["Color"]=="2" && rowData3["TrangThai"]!='HuyBo'){
							$("#rowed5").jqGrid('setRowData', tmp3[i], false, { background: '#FDFCC2',border:'1px solid #dfd9c3' });
						}else if(rowData3["Color"]=="3" && rowData3["TrangThai"]!='HuyBo'){
							$("#rowed5").jqGrid('setRowData', tmp3[i], false, { background: '#DE5145',border:'1px solid #dfd9c3' });
						}
					}
					if((rowData3["IDNhomCLS"]==17)&&(y==0)&&($('#'+tmp3[i]+'_ThucHien').val()==1)){
						window.id_rowcls=tmp3[i];
						y++;
					}
					if((rowData3["IDNhomCLS"]==17)&&(x==0)){
						window.id_rowcls2=tmp3[i];
						x++;
					}
				}
				tinhtongtien();
		}else{
			alert_khoa(datacheck);
		}
	});
}//end func
</script>